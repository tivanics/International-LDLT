---
title: "ForGabi"
output:
  word_document: default
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width = 10, fig.height = 12, results="asis")
```

```{r}
library(ggplot2)
library(dplyr)
library(tidyverse)
library(magrittr)
library(scales)
library(ggsci)
library(plotly)
library(hrbrthemes)
options(scipen=999)
```

```{r dataprep May19}
# data preparation

# (my understanding of the data may need double checking from you, but
# if the bound3 source contains all cases, and all LDLTs are clasiified somehow,
# then tthis should be correct)

bound3 <- readRDS(file = "./bound3forgraph.rds")
bound2 <- read_csv("./merged.csv", guess_max = 300000)
bound3 <- bound2 %>% filter(DTYPE == "LDLT" & GRAFT_TYPE == "Segmental")
bound3 <- bound3 %>% filter(!is.na(GRAFT_LATERALITY))
rm(bound2)

# Total transplants counts  for living donors, according to
# additional filter of GRAFT_TYPE you used above,
# by year, by country, 2008-2018
LDLT_country_year <- bound3 %>%
  group_by(TX_YR, COUNTRY) %>%
  mutate(countYEAR = n()) %>%
  ungroup() %>%
  select(TX_YR, COUNTRY, countYEAR) %>%
  unique() %>%
  arrange(TX_YR)
LDLT_country_year$GRAFT_LATERALITY <- "Total LDLT"

LDLT_rightlobe_country_year <- bound3 %>%
  filter(!is.na(GRAFT_LATERALITY) & GRAFT_LATERALITY == "Right lobe") %>% 
  group_by(TX_YR, COUNTRY) %>%
  mutate(countYEAR = n()) %>%
  ungroup() %>%
  select(TX_YR, COUNTRY, countYEAR, GRAFT_LATERALITY) %>%
  unique() %>%
  arrange(TX_YR)

LDLT_leftlobe_country_year <- bound3 %>%
  filter(!is.na(GRAFT_LATERALITY) & GRAFT_LATERALITY == "Left lobe") %>% 
  group_by(TX_YR, COUNTRY) %>%
  mutate(countYEAR = n()) %>%
  ungroup() %>%
  select(TX_YR, COUNTRY, countYEAR, GRAFT_LATERALITY) %>%
  unique() %>%
  arrange(TX_YR)

LDLT_leftlateral_country_year <- bound3 %>%
  filter(!is.na(GRAFT_LATERALITY) & GRAFT_LATERALITY == "Left lateral segment") %>% 
  group_by(TX_YR, COUNTRY) %>%
  mutate(countYEAR = n()) %>%
  ungroup() %>%
  select(TX_YR, COUNTRY, countYEAR, GRAFT_LATERALITY) %>%
  unique() %>%
  arrange(TX_YR)

rm(bound3)

# Combine the above subtables into 1 large table, factored by country and by GRAFT_TYPE
LDLT_country_year_type <- bind_rows(LDLT_country_year, LDLT_rightlobe_country_year) %>%
  bind_rows(LDLT_leftlobe_country_year) %>%
  bind_rows(LDLT_leftlateral_country_year)

LDLT_country_year_type$COUNTRY <- factor(LDLT_country_year_type$COUNTRY, levels = c("US", "CAN", "UK"))
LDLT_country_year_type$GRAFT_LATERALITY <- factor(LDLT_country_year_type$GRAFT_LATERALITY, 
                                                  levels = c("Total LDLT",
                                                             "Right lobe", 
                                                             "Left lobe", 
                                                             "Left lateral segment"))
# LDLT_rightlobe_country_year$COUNTRY <- factor(LDLT_rightlobe_country_year$COUNTRY, levels = c("US", "CAN", "UK"))
# LDLT_leftlobe_country_year$COUNTRY <- factor(LDLT_leftlobe_country_year$COUNTRY, levels = c("US", "CAN", "UK"))
# LDLT_leftlateral_country_year$COUNTRY <- factor(LDLT_leftlateral_country_year$COUNTRY, levels = c("US", "CAN", "UK"))

rm(LDLT_country_year)
rm(LDLT_leftlateral_country_year)
rm(LDLT_leftlobe_country_year)
rm(LDLT_rightlobe_country_year)


# set aside and order the data we care about labeling:
labeled_subset_country_year_type <- subset(LDLT_country_year_type,
                                           TX_YR %in% c(2008, 2010, 2012, 2014, 2016, 2018)) %>%
  arrange(TX_YR)

```

``` {r ggplot2}
# TODO: arrange plot
# bcd8c1 mint
# e9d985 flax
# colour palette: https://coolors.co/222e50-439a86-007991-e9d985-389957
# One of the reviewers asked if we could evaluate the trends in the use of various graft types in the different countries.
# the graph below shows, compared to total LDLT completed, which was done of the various graft types. 
# Each row is a different country.
# Each column is a different graft type. Each graft type is a different colour. "Total LDLT" is a graft type representing all LDLT performed

# ggplot object - faceted
ggp <- ggplot(NULL, aes(TX_YR, countYEAR)) +    # Draw ggplot2 plot based on two data frames
  geom_area(fill  ="#bcd8c1",
            alpha = 0.5, 
            data = LDLT_country_year_type, 
            col = "#bcd8c1",
            mapping = aes(fill = "Total LDLT")) +
  
  geom_area(fill = c("#439a86"), 
            alpha = 0.5, 
            data = LDLT_rightlobe_country_year, 
            mapping = aes(fill = "countYEAR"),
            col = c("#439a86")) +
  
  geom_area(fill = c("#007991"), 
            alpha = 0.5, 
            data = LDLT_leftlobe_country_year, 
            mapping = aes(fill = "countYEAR"),
            col = c("#007991")) +

  geom_area(fill = c("#222e50"), 
            alpha = 0.5, 
            data = LDLT_leftlateral_country_year, 
            mapping = aes(fill = "countYEAR"),
            col = c("#222e50")) +

  facet_grid(GRAFT_LATERALITY ~ COUNTRY, scales="free_y", margins = TRUE) +
  scale_x_continuous(limits = c(2008, 2018), 
                     breaks = c(2008, 2010, 2012, 2014, 2016, 2018))+
  scale_y_continuous(expand = expansion(mult = c(0, 0))) +
  
 
  # label the proportion of LDLT done for that year; label only 
  # the years of the x-axis breaks (to save space, optional ofc)
  # customize nudge amount for each country factor
  geom_text(data = US_labeled_subset_LDLT_country_year, 
             label = percent(US_labeled_subset_LDLT_country_year$countYEAR /
                               US_labeled_subset_total_transplants_country_year$countYEAR, 
                             accuracy = 0.1),
            size = 5,
            vjust = 0,
            nudge_y = 5,
            col = "#28193D",
            fontface = "bold") +
  geom_text(data = UK_labeled_subset_LDLT_country_year, 
             label = percent(UK_labeled_subset_LDLT_country_year$countYEAR /
                               UK_labeled_subset_total_transplants_country_year$countYEAR, 
                             accuracy = 0.1),
            size = 5,
            vjust = 0,
            nudge_y = 1,
            col = "#28193D",
            fontface = "bold") +
  geom_text(data = CAN_labeled_subset_LDLT_country_year, 
             label = percent(CAN_labeled_subset_LDLT_country_year$countYEAR /
                               CAN_labeled_subset_total_transplants_country_year$countYEAR, 
                             accuracy = 0.1),
            size = 5,
            vjust = 0,
            nudge_y = -5,
            col = "#28193D",
            fontface = "bold") +
  
  xlab("\nYear of transplant") +
  ylab("Number of transplants\n") +
  theme_minimal() +

  theme(axis.title = element_text(size = 14, family = "serif"),
        strip.text.y = element_text(angle = 0, 
                                    size = 20,
                                    face = "bold",
                                    colour = "#28193D",
                                    family = "serif"),
        axis.text.x = element_text(size = 18, colour = "#424949"),
        axis.title.x = element_text(hjust = 0.95, colour = "#424949"),
        axis.title.y = element_text(angle = 90, hjust = 1, colour = "#424949"),
        axis.text.y = element_text(size = 14, colour = "#424949"), 
        panel.spacing.y = unit(3, "lines"),
        panel.grid.major = element_line(colour = "#F2F4F4"),
        panel.grid.minor = element_blank()) 
  

 
ggp
```



