---
title: "UNOS"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width = 10, fig.height = 12, results="asis")
```


```{r}
library(ggplot2)
library(survminer)
library(survival)
library(dplyr)
library(tidyverse)
library(data.table) 
library(forestmodel) 
library(Hmisc) 
library(sjPlot) 
library(stargazer) 
library(sjmisc) 
library(arsenal) 
library(gtsummary)
library(expss) 
library(lubridate)
library(ggsignif)
library(haven)
scipen=999
```

**Read in data**
```{r}
unosdata <- read_csv("/Users/Ivanics/Desktop/UNOSDATA.csv", guess_max = 300000)
```

**Recoding and renaming**
```{r}
unosdata <- unosdata %>% 
  rename(REGID=PT_CODE)

#Keep analysis from 2008 onwards
unosdata <- unosdata %>% filter(
  TX_YEAR >= 2008 & TX_YEAR <= 2018
)

#Rename TX_YEAR variable
unosdata <- unosdata %>%
  rename(TX_YR = TX_YEAR)

#Remove missing survival information
unosdata <- unosdata %>% filter(
  GTIME >= 0
)

unosdata <- unosdata %>% filter(
  PTIME >= 0
)

#Keep only adult patients
unosdata <- unosdata %>% filter(
  AGE >= 18
)

unosdata <- unosdata %>% 
  rename(RAGE = AGE)

#Limit to first-time liver only transplants 
unosdata <- unosdata %>% filter(
  NUM_PREV_TX == 0 & PREV_TX == "N"
)

unosdata <- unosdata %>% filter(
  is.na(MULTIORG)
)


unosdata <- unosdata %>% filter(
  TX_PROCEDUR_TY != 704
)

unosdata <- unosdata %>% 
  rename(GSURV = GTIME,
         GCENS = GSTATUS,
         PSURV = PTIME,
         PCENS = PSTATUS
         )
#Drop liver cancer patients who do NOT have HCC
unosdata <- unosdata %>% mutate(
  LC = case_when(
    DIAG == 4402 ~ 1,
    DIAG == 4403 ~ 1,
    DIAG == 4404 ~ 1,
    DIAG == 4405 ~ 1, 
    DIAG == 4420 ~ 1,
    DIAG == 4430 ~ 1,
    DIAG == 4410 ~ 1,
    TRUE ~ 0
  )
)
```

**Donor characteristics**
```{r}
#Donor age
unosdata <- unosdata %>% rename(
  DAGE = AGE_DON
)

#Donor type
unosdata$DCD <- 
  recode(unosdata$NON_HRT_DON,
                               c("Y"~1,
                                 "N"~0
                                 ))

unosdata$LDLT <- 
  recode(unosdata$DON_TY,
                               c("L"~1,
                                 "C"~0
                                 ))

unosdata <- unosdata %>% mutate(
  DTYPE = case_when(
    DCD == 1 ~ 1,
    LDLT == 1 ~ 2,
    TRUE ~ 0
  )
)

unosdata <- unosdata %>% mutate(
  DTYPE = factor(DTYPE, labels = c("DBD", "DCD", "LDLT")) 
)

#Cause of death
unosdata <- unosdata %>% mutate(
  DONCOD = case_when(
    COD_CAD_DON == 3 ~ 1,
    COD_CAD_DON == 2 ~ 2,
    COD_CAD_DON == 1 ~ 3,
    COD_CAD_DON == 4 ~ 4
  )
)

unosdata <- unosdata %>% mutate(
  DONCOD = factor(DONCOD, labels = c("Trauma", "CVA", "Cerebral Anoxia", "Other")) 
)

#BMI
unosdata <- unosdata %>% rename(DBMI = BMI_DON_CALC)

#Donor sex
unosdata$DSEX <- 
  recode(unosdata$GENDER,
                               c("F"~0,
                                 "M"~1
                                 ))


unosdata <- unosdata %>% mutate(
  DSEX = factor(DSEX, labels = c("Female", "Male"))
)

#Donor ABO match
unosdata <- unosdata %>% mutate(BLD_GP_MATCH = factor(ABO_MAT, labels = c("Identical", "Compatible", "Incompatible")))

#Donor graft type
unosdata <- unosdata %>% mutate(
  GRAFT_TYPE = case_when(
    TX_PROCEDUR_TY == 701 ~ 1,
    TX_PROCEDUR_TY == 702 ~ 2,
    TX_PROCEDUR_TY == 703 ~ 2
  )
)

unosdata <- unosdata %>% mutate(
  GRAFT_TYPE = factor(GRAFT_TYPE, labels= c("Whole", "Segmental"))
)

#CIT
unosdata <- unosdata %>% mutate(
  CIT = COLD_ISCH*60
)

#CMV status donor
unosdata <- unosdata %>% mutate(
  DCMV = case_when(
    unosdata$CMV_DON == "P" ~ 1,
    unosdata$CMV_DON == "N" ~ 0,
    TRUE ~ NA_real_)) 

unosdata <- unosdata %>% mutate(DCMV = 
    factor(DCMV, labels = c("Negative", "Positive")))

```

**Recipient characteristics**
```{r}
#Gender
unosdata <- unosdata %>% mutate(
  RSEX = case_when(
    GENDER == "M" ~ 1,
    GENDER == "F" ~ 0
  ) 
)

unosdata <- unosdata %>% mutate(
  RSEX = factor(RSEX, labels = c("Female", "Male"))
)

#Ethnicity
unosdata <- unosdata %>% mutate(
  RETHNIC = case_when(
    ETHCAT == 1 ~ 0,
    ETHCAT == 2 ~ 1,
    TRUE ~ 2,
  )
)

unosdata <- unosdata %>% mutate(
  RETHNIC = factor(RETHNIC, labels = c("White", "Black", "Other"))
)
  

#Recipient BMI
unosdata <- unosdata %>% rename(
  BMI = BMI_CALC
)

#Waiting list
unosdata <- unosdata %>% rename(
  WAITLIST_TIME = DAYSWAIT_CHRON
)

#Transplant unit
unosdata <- unosdata %>% mutate(
  TRANSPLANT_UNIT = factor(CTR_CODE)
)


#Recipient MELD score
unosdata <- unosdata %>% rename(
  MELD = FINAL_MELD_PELD_LAB_SCORE
)

#Renal support
unosdata$RREN_SUP <- 
  recode(unosdata$FINAL_DIALYSIS_PRIOR_WEEK,
                               c("Y"~1,
                                 "N"~0
                               ))

unosdata <- unosdata %>% mutate(
  RREN_SUP = factor(RREN_SUP, labels = c("No pre-tx support", "Pre-tx support"))
)

#Ventilatory support
unosdata <- unosdata %>% mutate(
  RVENT = ON_VENT_TRR  
) %>%
  mutate(
    RVENT = factor(
      RVENT, labels = 
        c("Not ventilated", "Ventilated"
          )))
  
#Previous abdominal surgery
unosdata$RAB_SURGERY <- recode(unosdata$PREV_AB_SURG_TRR,
                               c("Y" ~ 1,
                                 "N" ~ 0,
                                 "U" ~ NA))


unosdata <- unosdata %>% mutate(
  RAB_SURGERY = factor(RAB_SURGERY, labels = c("No", "Yes"))
)

#Functional status
unosdata <- unosdata %>% mutate(
  RLIFE = case_when(
    FUNC_STAT_TRR == 2010 | FUNC_STAT_TRR == 2020 | FUNC_STAT_TRR == 2030 | FUNC_STAT_TRR == 2040 ~ 1,
    FUNC_STAT_TRR == 2050 | FUNC_STAT_TRR == 2060 | FUNC_STAT_TRR == 2070 ~ 2,
    FUNC_STAT_TRR == 2080 | FUNC_STAT_TRR == 2090 | FUNC_STAT_TRR == 2100 ~ 3
  )
) %>%
  mutate(RLIFE = factor(RLIFE, labels = c("Low", "Intermediate", "High")))

#Ascites
unosdata <- unosdata %>% mutate(
  RASCITES = case_when(
    ASCITES_TX == 1 ~ 0,
    ASCITES_TX == 2 | ASCITES_TX == 3 ~ 1,
    ASCITES_TX == 4 ~ 0
  )
) %>%
  mutate(RASCITES = factor(RASCITES, labels = c("No ascites", "Ascites")))

#Encephalopathy
unosdata <- unosdata %>% mutate(
  RENCEPH = case_when(
    ENCEPH_TX == 1 ~ 0,
    ENCEPH_TX == 2 | ENCEPH_TX == 3 ~ 1,
    ENCEPH_TX == 4 ~ 0
  )
) %>%
  mutate(RENCEPH = factor(RENCEPH, labels = c("Not encephalopathic", "Encephalopathic")))

#Recipient blood group
unosdata <- unosdata %>% mutate(
  RBG = case_when(
    ABO == "O" ~ 1,
    ABO == "A" ~ 2,
    ABO == "A1" ~ 2,
    ABO == "A2" ~ 2,
    ABO == "B" ~ 3,
    ABO == "A1B" ~ 4,
    ABO == "A2B" ~ 4,
    ABO == "AB" ~ 4
  )
) %>%
  mutate(RBG = factor(RBG, labels = c("0", "A", "B", "AB")))

#Recipient HCV status
unosdata$RANTI_HCV <- recode(unosdata$HCV_SEROSTATUS,
                             "N" ~ 0,
                             "ND" ~ NA,
                             "P" ~ 1,
                             "U" ~ NA,
                             TRUE ~ NA)

unosdata <- unosdata %>%
  mutate(RANTI_HCV = factor(RANTI_HCV, labels = c("Negative", "Positive")))

#Albumin
unosdata <- unosdata %>% rename(
  RALBUMIN = ALBUMIN_TX
)

#INR
unosdata <- unosdata %>% mutate(
  RINR = FINAL_INR
)

#Bilirubin
unosdata <- unosdata %>% rename(
  RBILIRUBIN = TBILI_TX
)

#Creatinine
unosdata <- unosdata %>% rename(
  RCREAT = CREAT_TX
)

unosdata <- unosdata %>% mutate(
  COUNTRY = case_when(
    PCENS >= 0 ~ "US"
  )
)

#Disease Etiology
#Freetext searches
#pattern for HCC                
pattern1 <- c("[hH][eE][pP][aA][tT][oO][cC][eE][lL][lL][uU][lL][aA][rR].[cC]|[hH][cC][cC]|[hH][eE][pP][aA][tT][oO][mM][aA]")

unosdata <- unosdata %>% mutate(
  HCCfreetext = case_when(
    grepl("[hH][eE][pP][aA][tT][oO][cC][eE][lL][lL][uU][lL][aA][rR].[cC]|[hH][cC][cC]|[hH][eE][pP][aA][tT][oO][mM][aA]", DIAG_OSTXT) == TRUE ~ 1,
    TRUE ~ 0
  )
)

unosdata <- unosdata %>% mutate(
  HCCfreetext2 = case_when(
    grepl("[hH][eE][pP][aA][tT][oO][cC][eE][lL][lL][uU][lL][aA][rR].[cC]|[hH][cC][cC]|[hH][eE][pP][aA][tT][oO][mM][aA]", DGN_OSTXT_TCR) == TRUE ~ 1,
    TRUE ~ 0
  )
)

unosdata <- unosdata %>% mutate(
  HCCfreetext3 = case_when(
    grepl("[hH][eE][pP][aA][tT][oO][cC][eE][lL][lL][uU][lL][aA][rR].[cC]|[hH][cC][cC]|[hH][eE][pP][aA][tT][oO][mM][aA]", DGN2_OSTXT_TCR) == TRUE ~ 1,
    TRUE ~ 0
  )
)

#HCV freetext
unosdata <- unosdata %>% mutate(
  HCVfreetext = case_when(
    grepl("[hH][cC][vV]|[hH][eE][pP][aA][tT][iI][sS].[cC]|[hH][eE][pP].[cC]", DIAG_OSTXT) == TRUE ~ 1,
    TRUE ~ 0
  )
  )

#PSC freetext
unosdata <- unosdata %>% mutate(
  PSCfreetext = case_when(
    grepl("[pP][sS][cC]|[pP][rR][iI][mM][aA][rR][yY].[sS][cC][lL][eE][rR][oO][sS][iI][nN][gG].[cC][hH][oO][lL][aA][nN][gG][iI][tT][iI][sS]|[pP][rR][iI][mM][aA][rR][yY].[sS][cC][lL][eE][rR][oO][sS][iI][nN][gG]", DIAG_OSTXT) == TRUE ~ 1,
    TRUE ~ 0
  )
)

#HBV freetext
unosdata <- unosdata %>% mutate(
  HBVfreetext = case_when(
    grepl("[hH][bB][vV]|[hH][eE][pP][aA][tT][iI][tT][iI][sS].[bB]|[hH][eE][pP].[bB]|", DIAG_OSTXT) == TRUE ~ 1,
    TRUE ~ 0
  )
)


#PBC freetext 
unosdata <- unosdata %>% mutate(
  PBCfreetext = case_when(
    grepl("[pP][bB][cC]|[pP][rR][iI][mM][aA][rR][yY].[bB][iI][lL][iI][aA][rR][yY]", DIAG_OSTXT) == TRUE ~ 1,
    TRUE ~ 0
  )
)

#ALD
unosdata <-unosdata %>% mutate(
  ALDfreetext= case_when(
    grepl("[^aA][lL][dD][.]|[aA][lL][cC][oO][hH]|[aA][lL][cC][oO][hH][oO][lL][iI][cC]|[^aA][lL][cC][oO][hH][oO][lL][iI][cC].[lL][iI][vV][eE][rR].[dD][iI][sS][eE][aA][sS][eE]", DIAG_OSTXT) == TRUE ~ 1,
    TRUE ~ 0
  )
)

#AID
unosdata <-unosdata %>% mutate(
  AIDfreetext= case_when(
    grepl("[aA][iI][hH]|[aA][uU][tT][oO][iI][mM][mM][uU][nN][eE]", DIAG_OSTXT) == TRUE ~ 1,
    TRUE ~ 0
  )
)

#NASH
unosdata <-unosdata %>% mutate(
  NASHfreetext= case_when(
    grepl("[nN][aA][sS][hH]|[nN][oO][nN][.][aA][lL][cC]|[nN][oO][nN][-][aA][lL][cC][oO][hH][oO][lL][iI][cC]|[fF][aA][tT]|[nN][aA][fF][lL][dD]|[nN][oO][nN].[aA][lL][cC][oO][lL][iI][cC].[sS]|[sS][tT][eE][aA][tT]", DIAG_OSTXT) == TRUE ~ 1,
    TRUE ~ 0
  )
)

unosdata <-unosdata %>% mutate(
  NASHfreetext2= case_when(
    grepl("[nN][aA][sS][hH]|[nN][oO][nN][.][aA][lL][cC]|[nN][oO][nN][-][aA][lL][cC][oO][hH][oO][lL][iI][cC]|[fF][aA][tT]|[nN][aA][fF][lL][dD]|[nN][oO][nN].[aA][lL][cC][oO][lL][iI][cC].[sS]|[sS][tT][eE][aA][tT]", DGN_OSTXT_TCR) == TRUE ~ 1,
    TRUE ~ 0
  )
)

unosdata <-unosdata %>% mutate(
  NASHfreetext3= case_when(
    grepl("[nN][aA][sS][hH]|[nN][oO][nN][.][aA][lL][cC]|[nN][oO][nN][-][aA][lL][cC][oO][hH][oO][lL][iI][cC]|[fF][aA][tT]|[nN][aA][fF][lL][dD]|[nN][oO][nN].[aA][lL][cC][oO][lL][iI][cC].[sS]|[sS][tT][eE][aA][tT]", DGN2_OSTXT_TCR) == TRUE ~ 1,
    TRUE ~ 0
  )
)

#NASH
unosdata <- unosdata %>% mutate(
  NASH = case_when(
    NASHfreetext == 1 ~ 1,
    DIAG == 4214 ~ 1,
    DGN_TCR == 4214 ~ 1,
    DGN2_TCR == 4214 ~ 1,
    NASHfreetext2 == 1 ~ 1,
    NASHfreetext3 == 1 ~ 1,
    TRUE ~ 0
  )
)

#Disease etiology
#HCC
unosdata <- unosdata %>% mutate(
  HCC = case_when(
    DIAG == 4400 ~ 1,
    DIAG == 4401 ~ 1,
    DGN_TCR == 4400 ~ 1,
    DGN_TCR == 4401 ~ 1,
    DGN2_TCR == 4400 ~ 1,
    DGN2_TCR == 4401 ~ 1,
    HCCfreetext == 1 ~ 1,
    HCCfreetext2 == 1 ~1,
    HCCfreetext3 == 1 ~ 1,
    TRUE ~ 0
  )
)

#ALF
unosdata <- unosdata %>% mutate(
  ALF = case_when(
    DIAG == 4110 ~ 1,
    DIAG == 4101 ~ 1,
    DIAG == 4102 ~ 1,
    DIAG == 4103 ~ 1,
    DIAG == 4104 ~ 1,
    DIAG == 4105 ~ 1,
    DIAG == 4106 ~ 1,
    DIAG == 4107 ~ 1,
    DIAG == 4106 ~ 1,
    DIAG == 4108 ~ 1,
    DIAG == 4100 ~ 1,
    DIAG == 4520 ~ 1,
    TRUE ~ 0
  )
)

#HCV
unosdata <- unosdata %>% mutate(
  HCV = case_when(
    DIAG == 4202 ~ 1,
    DIAG == 4206 ~ 1,
    DIAG == 4216 ~ 1,
    TRUE ~ 0
  )
)

#PSC
unosdata <- unosdata %>% mutate(
  PSC = case_when(
    DIAG == 4240 ~ 1,
    DIAG == 4241 ~ 1,
    DIAG == 4242 ~ 1,
    DIAG == 4245 ~ 1,
    TRUE ~ 0
  )
)

#HBV
unosdata <- unosdata %>% mutate(
  HBV = case_when(
    DIAG == 4202 ~ 1,
    DIAG == 4207 ~ 1,
    DIAG == 4205 ~ 1,
    TRUE ~ 0
  )
)

#PBC
unosdata <- unosdata %>% mutate(
  PBC = case_when(
    DIAG == 4220 ~ 1,
    TRUE ~ 0
  )
)

#Alcoholic
unosdata <- unosdata %>% mutate(
  ALD = case_when(
    DIAG == 4215 ~ 1,
    DIAG == 4217 ~ 1,
    TRUE ~ 0
  )
)

#Autoimmune and cryptogenic
unosdata <- unosdata %>% mutate(
  AID = case_when(
    DIAG == 4212 ~ 1,
    DIAG == 4213 ~ 1,
    DIAG == 4200 ~ 1,
    DIAG == 4209 ~ 1,
    DIAG == 4203 ~ 1,
    DIAG == 4208 ~ 1,
    DIAG == 4210 ~ 1,
    TRUE ~ 0
  )
)

#Metabolic liver disease
unosdata <- unosdata %>% mutate(
  MET = case_when(
    DIAG == 4300 ~ 1,
    DIAG == 4301 ~ 1,
    DIAG == 4302 ~ 1,
    DIAG == 4303 ~ 1,
    DIAG == 4304 ~ 1,
    DIAG == 4305 ~ 1,
    DIAG == 4306 ~ 1,
    DIAG == 4307 ~ 1,
    DIAG == 4308 ~ 1,
    DIAG == 4315 ~ 1,
    DIAG == 4214 ~ 1,
    TRUE ~ 0
  )
)

#Other 
unosdata <- unosdata %>% mutate(
  OTH = case_when(
    DIAG == 4201 ~ 1,
    DIAG == 4230 ~ 1,
    DIAG == 4231 ~ 1,
    DIAG == 4235 ~ 1,
    DIAG == 4250 ~ 1,
    DIAG == 4255 ~ 1,
    DIAG == 4260 ~ 1,
    DIAG == 4265 ~ 1,
    DIAG == 4270 ~ 1,
    DIAG == 4271 ~ 1,
    DIAG == 4272 ~ 1,
    DIAG == 4275 ~ 1,
    DIAG == 4280 ~ 1,
    DIAG == 4285 ~ 1,
    DIAG == 4290 ~ 1,
    DIAG == 4450 ~ 1,
    DIAG == 4451 ~ 1,
    DIAG == 4455 ~ 1,
    DIAG == 4510 ~ 1,
    DIAG == 4500 ~ 1,
    DIAG == 4598 ~ 1,
    DIAG == 999 ~ 1,
    TRUE ~ 0
  )
)

unosdata <- unosdata %>% mutate(
  UKT_PLDGRP = case_when(
    HCC == 1 | HCCfreetext == 1 ~ 1,
    ALF == 1 ~ 2,
    HCV == 1 | HCVfreetext == 1 & HCCfreetext == 0 ~ 3,
    PSC == 1 | PSCfreetext == 1 ~ 4,
    HBV == 1 | HBVfreetext == 1 ~ 5,
    PBC == 1 | PBCfreetext == 1 ~ 6,
    ALD == 1 | ALDfreetext == 1~ 7,
    AID == 1 | AIDfreetext == 1 ~ 8,
    MET == 1 | NASHfreetext == 1 ~ 9,
    OTH == 1 ~ 10
  )
) %>%
  mutate(UKT_PLDGRP = factor(UKT_PLDGRP, labels = c("HCC", "ALF", "HCV", "PSC", "HBV", "PBC", "ALD", "AID", "Metabolic", "Others")))

#Combined HCC
unosdata <- unosdata %>% mutate(
  HCC_combined = case_when(
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4202 ~ 1,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4206 ~ 1,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4216 ~ 1,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4202 ~ 1,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4206 ~ 1,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4216 ~ 1,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4240 ~ 2,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4241 ~ 2,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4242 ~ 2,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4245 ~ 2,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4240 ~ 2,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4241 ~ 2,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4242 ~ 2,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4245 ~ 2,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4207 ~ 3,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4205 ~ 3,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4207 ~ 3,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4205 ~ 3,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4220 ~ 4,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4220 ~ 4,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4215 ~ 5,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4217 ~ 5,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4215 ~ 5,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4217 ~ 5,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4212 ~ 6,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4213 ~ 6,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4200 ~ 6,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4209 ~ 6,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4203 ~ 6,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4208 ~ 6,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4210 ~ 6,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4212 ~ 6,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4213 ~ 6,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4200 ~ 6,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4209 ~ 6,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4203 ~ 6,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4208 ~ 6,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4210 ~ 6,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4300 ~ 7,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4301 ~ 7,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4302 ~ 7,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4303 ~ 7,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4304 ~ 7,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4305 ~ 7,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4306 ~ 7,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4307 ~ 7,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4308 ~ 7,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4315 ~ 7,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4314 ~ 7,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4300 ~ 7,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4301 ~ 7,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4302 ~ 7,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4303 ~ 7,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4304 ~ 7,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4305 ~ 7,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4306 ~ 7,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4307 ~ 7,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4308 ~ 7,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4315 ~ 7,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4314 ~ 7,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4201 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4230 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4231 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4235 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4250 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4255 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4260 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4265 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4270 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4271 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4272 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4275 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4280 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4285 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4290 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4450 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4451 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4455 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4510 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4500 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 4598 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN_TCR == 999 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4201 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4230 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4231 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4235 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4250 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4255 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4260 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4265 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4270 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4271 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4272 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4275 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4280 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4285 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4290 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4450 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4451 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4455 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4510 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4500 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 4598 ~ 8,
    unosdata$HCC == 1 & unosdata$DGN2_TCR == 999 ~ 8,
    TRUE ~ 8)) 

unosdata <- unosdata %>% mutate(
  HCC_combined = factor(HCC_combined, labels = c("HCV-associated", "PSC-associated", "HBV-associated", "PBC-associated", "ALD-associated", "AID-associated", "MET-associated", "Other"))
)
```

**Causes of death**
```{r}
unosdata <- unosdata %>% mutate(
  COD_cardiovascular = case_when(
    COD == 4620 ~ 1,
    COD2 == 4620 ~ 1,
    COD3 == 4620 ~ 1,
    COD == 4622 ~ 1,
    COD2 == 4622 ~ 1,
    COD3 == 4622 ~ 1,
    COD == 4623 ~ 1,
    COD2 == 4623 ~ 1,
    COD3 == 4623 ~ 1,
    COD == 4624 ~ 1,
    COD2 == 4624 ~ 1,
    COD3 == 4624 ~ 1,
    COD == 4625 ~ 1,
    COD2 == 4625 ~ 1,
    COD3 == 4625 ~ 1,
    COD == 4626 ~ 1,
    COD2 == 4626 ~ 1,
    COD3 == 4626 ~ 1,
    COD == 4246 ~ 1,
    COD2 == 4246 ~ 1,
    COD3 == 4246 ~ 1,
    COD == 4247 ~ 1,
    COD2 == 4247 ~ 1,
    COD3 == 4247 ~ 1,
    COD == 4621 ~ 1,
    COD2 == 4621 ~ 1,
    COD3 == 4621 ~ 1,
    COD == 4630 ~ 1,
    COD2 == 4630 ~ 1,
    COD3 == 4630 ~ 1,
    COD == 4631 ~ 1,
    COD2 == 4631 ~ 1,
    COD3 == 4631 ~ 1,
    COD == 4701 ~ 1,
    COD2 == 4701 ~ 1,
    COD3 == 4701 ~ 1,
    COD == 4635 ~ 1,
    COD2 == 4635 ~ 1,
    COD3 == 4635 ~ 1,
    COD == 4700 ~ 1,
    COD2 == 4700 ~ 1,
    COD3 == 4700 ~ 1,
    COD == 4702 ~ 1,
    COD2 == 4702 ~ 1,
    COD3 == 4702 ~ 1,
    COD == 4703 ~ 1,
    COD2 == 4703 ~ 1,
    COD3 == 4703 ~ 1,
    COD == 4705 ~ 1,
    COD2 == 4705 ~ 1,
    COD3 == 4705 ~ 1,
    COD == 4706 ~ 1,
    COD2 == 4706 ~ 1,
    COD3 == 4706 ~ 1,
    TRUE ~ 0))

unosdata <- unosdata %>% mutate(COD_cardiovascular = factor(COD_cardiovascular, labels = c("Cardiovascular COD", "Noncardiovascular COD")))

unosdata <- unosdata %>% mutate(
  COD_malignancy = case_when(
    COD == 4850 ~ 1,
    COD2 == 4850 ~ 1,
    COD3 == 4850 ~ 1,
    COD == 4851 ~ 1,
    COD2 == 4851 ~ 1,
    COD3 == 4851 ~ 1,
    COD == 4855 ~ 1,
    COD2 == 4855 ~ 1,
    COD3 == 4855 ~ 1,
    COD == 4856 ~ 1,
    COD2 == 4856 ~ 1,
    COD3 == 4856 ~ 1,
    COD == 4860 ~ 1,
    COD2 == 4860 ~ 1,
    COD3 == 4860 ~ 1,
    COD == 4951 ~ 1,
    COD2 == 4951 ~ 1,
    COD3 == 4951 ~ 1,
    COD == 4952 ~ 1,
    COD2 == 4952 ~ 1,
    COD3 == 4952 ~ 1,
    COD == 4953 ~ 1,
    COD2 == 4953 ~ 1,
    COD3 == 4953 ~ 1,
    TRUE ~ 0))

unosdata <- unosdata %>% mutate(COD_malignancy = factor(COD_malignancy, labels = c("Malignancy-related COD", "Nonmalignancy-related COD")))

unosdata <- unosdata %>% mutate(
  COD_infection = case_when(
    COD == 4800 ~ 1,
    COD2 == 4800 ~ 1,
    COD3 == 4800 ~ 1,
    COD == 4801 ~ 1,
    COD2 == 4801 ~ 1,
    COD3 == 4801 ~ 1,
    COD == 4802 ~ 1,
    COD2 == 4802 ~ 1,
    COD3 == 4802 ~ 1,
    COD == 4803 ~ 1,
    COD2 == 4803 ~ 1,
    COD3 == 4803 ~ 1,
    COD == 4804 ~ 1,
    COD2 == 4804 ~ 1,
    COD3 == 4804 ~ 1,
    COD == 4805 ~ 1,
    COD2 == 4805 ~ 1,
    COD3 == 4805 ~ 1,
    COD == 4950 ~ 1,
    COD2 == 4950 ~ 1,
    COD3 == 4950 ~ 1,
    COD == 4806 ~ 1,
    COD2 == 4806 ~ 1,
    COD3 == 4806 ~ 1,
    COD == 4810 ~ 1,
    COD2 == 4810 ~ 1,
    COD3 == 4810 ~ 1,
    COD == 4811 ~ 1,
    COD2 == 4811 ~ 1,
    COD3 == 4811 ~ 1,
    TRUE ~ 0))

unosdata <- unosdata %>% mutate(COD_infection = factor(COD_infection, labels = c("Infection COD", "Noninfection COD")))

unosdata <- unosdata %>% mutate(
  COD_liverrelated = case_when(
    COD == 4600 ~ 1,
    COD2 == 4600 ~ 1,
    COD3 == 4600 ~ 1,
    COD == 4955 ~ 1,
    COD2 == 4955 ~ 1,
    COD3 == 4955 ~ 1,
    COD == 4601 ~ 1,
    COD2 == 4601 ~ 1,
    COD3 == 4601 ~ 1,
    COD == 4602 ~ 1,
    COD2 == 4602 ~ 1,
    COD3 == 4602 ~ 1,
    COD == 4603 ~ 1,
    COD2 == 4603 ~ 1,
    COD3 == 4603 ~ 1,
    COD == 4604 ~ 1,
    COD2 == 4604 ~ 1,
    COD3 == 4604 ~ 1,
    COD == 4605 ~ 1,
    COD2 == 4605 ~ 1,
    COD3 == 4605 ~ 1,
    COD == 4606 ~ 1,
    COD2 == 4606 ~ 1,
    COD3 == 4606 ~ 1,
    COD == 4610 ~ 1,
    COD2 == 4610 ~ 1,
    COD3 == 4610 ~ 1,
    COD == 4615 ~ 1,
    COD2 == 4615 ~ 1,
    COD3 == 4615 ~ 1,
    COD == 4956 ~ 1,
    COD2 == 4956 ~ 1,
    COD3 == 4956 ~ 1,
    COD == 4957 ~ 1,
    COD2 == 4957 ~ 1,
    COD3 == 4957 ~ 1,
    COD == 4958 ~ 1,
    COD2 == 4958 ~ 1,
    COD3 == 4958 ~ 1,
    TRUE ~ 0))

unosdata <- unosdata %>% mutate(COD_liverrelated = factor(COD_liverrelated, labels = c("Liver disease or graft failure COD", "Nonliverdisease or graft failure COD")))

unosdata <- unosdata %>% mutate(
  COD_other = case_when(
    COD == 4945 ~ 1,
    COD2 == 4945 ~ 1,
    COD3 == 4945 ~ 1,
    COD == 4650 ~ 1,
    COD2 == 4650 ~ 1,
    COD3 == 4650 ~ 1,
    COD == 4940 ~ 1,
    COD2 == 4940 ~ 1,
    COD3 == 4940 ~ 1,
    COD == 4941 ~ 1,
    COD2 == 4941 ~ 1,
    COD3 == 4941 ~ 1,
    COD == 4942 ~ 1,
    COD2 == 4942 ~ 1,
    COD3 == 4942 ~ 1,
    COD == 4640 ~ 1,
    COD2 == 4640 ~ 1,
    COD3 == 4640 ~ 1,
    COD == 4645 ~ 1,
    COD2 == 4645 ~ 1,
    COD3 == 4645 ~ 1,
    COD == 4910 ~ 1,
    COD2 == 4910 ~ 1,
    COD3 == 4910 ~ 1,
    COD == 4660 ~ 1,
    COD2 == 4660 ~ 1,
    COD3 == 4660 ~ 1,
    COD == 998 ~ 1,
    COD2 == 998 ~ 1,
    COD3 == 998 ~ 1,
    COD == 999 ~ 1,
    COD2 == 999 ~ 1,
    COD3 == 999 ~ 1,
    COD == 4900 ~ 1,
    COD2 == 4900 ~ 1,
    COD3 == 4900 ~ 1,
    COD == 4920 ~ 1,
    COD2 == 4920 ~ 1,
    COD3 == 4920 ~ 1,
    COD == 4930 ~ 1,
    COD2 == 4930 ~ 1,
    COD3 == 4930 ~ 1,
    COD == 4935 ~ 1,
    COD2 == 4935 ~ 1,
    COD3 == 4935 ~ 1,
    TRUE ~ 0))

unosdata <- unosdata %>% mutate(COD_other = factor(COD_other, labels = c("Other COD", "Non-Other (previously categorized) COD")))
```

**UK data cleaning**
**Read in data**
```{r}
ukfull<- read_csv("/Users/Ivanics/Desktop/transplant_asat11jun2020.csv", guess_max = 300000)

ukwl <- read_csv("/Users/Ivanics/Desktop/waiting_list_11jun2020.csv", guess_max = 300000)

#renaming with _txp2 suffix
ukwl <- ukwl %>%
  dplyr::rename_all(paste0, "_wl")

ukwl <- ukwl %>% 
  rename(REGID=regid_wl)

ukfull <- left_join(ukfull, ukwl, by="REGID")
```

**Filtering data**
```{r}
#Count number of missing in each variable
sapply(ukfull, function(transplant_date) sum(is.na(transplant_date)))

#Limit year
ukfull <- ukfull %>% filter(TX_YR <= 2018)

#Drop patient with missing patient or graft info
ukfull <- ukfull %>% 
  filter(PSURV >= 0 & GSURV >= 0)

#Drop pediatric patients
ukfull <- ukfull %>%
  filter(RAGE >= 18)

#Limit to first-time liver only transplants
ukfull <- ukfull %>%
  filter(GRAFT_NO == 1 & 
           TX_TYPE < 80 &
           TX_METHOD < 2 &
           ORG_TXD < 4)
```

**General: Filtering, recoding and renaming**
```{r}
#Transplant date
ukfull$transplant_date <- dmy(ukfull$transplant_date)

ukfull$reg_date_wl <- dmy(ukfull$reg_date_wl)

ukfull$WAITLIST_TIME <- difftime(ukfull$transplant_date, ukfull$reg_date_wl, units = c("days"))

ukfull$WAITLIST_TIME <- as.numeric(ukfull$WAITLIST_TIME)

#Liver cancer patients 
ukfull <- ukfull %>%
  rename(PLD = RCSPLD1,
         PLD2 = RCSPLD2, 
         PLD3 = RCSPLD3)

ukfull <- ukfull %>% 
  mutate(LC = case_when(
    PLD >= 443 & PLD <= 447 ~ 1,
    PLD2 >= 443 & PLD2 <= 447 ~ 1,
    PLD3 >= 443 & PLD3 <= 447 ~ 1,
    TRUE ~ 0))
```

**Donor: Filtering, recoding and renaming**
```{r}
ukfull <- ukfull %>%
  filter(DGRP < 4)

#Donor type of allograft
ukfull$DTYPE <- 
  recode(ukfull$DTYPE,
         c(1 ~ 0,
           2 ~ 1, 
           5 ~ 2,
           6 ~ 2,
           13 ~ 2
           ))

ukfull <- ukfull %>% 
  mutate(DTYPE = factor(DTYPE, labels = c("DBD", "DCD", "LDLT"))) 

#Donor cause of death
ukfull$DONCOD <- 
  recode(ukfull$DCOD,
    20 ~ 1, 
    21 ~ 1, 
    22 ~ 1, 
    23 ~ 1,
    24 ~ 1,
    29 ~ 1, 
    30 ~ 1, 
    31 ~ 1,
    39 ~ 1, 
    10 ~ 2,
    11 ~ 2,
    19 ~ 2,
    13 ~ 3,
    TRUE ~ 4)

ukfull <- ukfull %>% 
  mutate(DONCOD = factor(DONCOD, labels = c("Trauma", "CVA", "Cerebral Anoxia", "Other"))) 

#Donor BMI
ukfull$DBMI <- 
  recode(ukfull$DBMI,
    100 %thru% hi ~ NA, 
    lo %thru% 9.99 ~ NA, 
    TRUE ~ copy)

#Donor sex
ukfull$DSEX <- 
  recode(ukfull$DSEX,
         8 ~ NA,
         9 ~ NA,
         1 ~ copy,
         2 ~ 0
         )

ukfull <- ukfull %>% 
  mutate(DSEX = factor(DSEX, labels = c("Female", "Male"))) 

#Blood group
ukfull <- ukfull %>% 
  mutate(BLD_GP_MATCH = factor(ABOMATCH, labels = c("Identical", "Compatible", "Incompatible"))) 

#Donor graft types
ukfull <- ukfull %>% 
  mutate(GRAFT_TYPE = case_when(
    ORGAN == 40 ~ 1,
    ORGAN == 41 ~ 2,
    ORGAN == 42 ~ 2,
    ORGAN == 46 ~ 2
  ))

ukfull <- ukfull %>% 
  mutate(GRAFT_TYPE = factor(GRAFT_TYPE, labels = c("Whole", "Segmental"))) 

ukfull$CIT <- recode(ukfull$CIT,
                     8888 ~ NA,
                     9909 ~ NA,
                     9999 ~ NA,
                     TRUE ~ copy
                     )

#Donor CMV
ukfull <- ukfull %>% mutate(
  DCMV = case_when(
    ukfull$DCMV == 2 ~ 1,
    ukfull$DCMV == 1 ~ 0,
    ukfull$DCMV == 5 ~ 1,
    TRUE ~ NA_real_)) 

ukfull <- ukfull %>% mutate(DCMV = 
    factor(DCMV, labels = c("Negative", "Positive")))
```

**Recipient: Filtering, recoding and renaming**
```{r}
#Ethnicity
ukfull$RETHNIC <- recode(
  ukfull$RETHNIC,
  1 ~ 1,
  3 ~ 2,
  2 ~ 3,
  4 %thru% 7 ~ 3,
  TRUE ~ 3
)

ukfull <- ukfull %>% 
  mutate(RETHNIC = factor(RETHNIC, labels = c("White", "Black", "Other"))) 

ukfull <- ukfull %>% mutate(
  RSEX = case_when(
    RSEX == 1 ~ 1,
    RSEX == 2 ~ 0
  )
) %>% 
  mutate(RSEX = factor(RSEX, labels = c("Female", "Male")))

```

**Recipient waitlist**
```{r}
#Renal support
ukfull$RREN_SUP <- recode(
  ukfull$RREN_SUP,
                          8 ~ NA,
                          9 ~ NA,
                          3 ~ 0,
                          2 ~ 1
                          )
ukfull <- ukfull %>% 
  mutate(RREN_SUP = factor(RREN_SUP, labels = c("No pre-tx support", "Pre-tx support")))

#BMI (at registration)
ukfull <- ukfull %>% mutate(
  BMI = RWEIGHT/(RHEIGHT/100)^2
)

#Ventilatory support
ukfull$RVENT <- recode(
  ukfull$RVENT,
  8 ~ NA,
  9 ~ NA,
  1 ~ 0,
  2 ~ 1
)

ukfull <- ukfull %>% 
  mutate(RVENT = factor(RVENT, labels = c("Not ventilated", "Ventilated")))

#Previous abdominal surgery
ukfull$RAB_SURGERY <- recode(
  ukfull$RAB_SURGERY,
  8 ~ NA,
  9 ~ NA,
  2 ~ 1,
  1 ~ 0
)

ukfull <- ukfull %>% 
  mutate(RAB_SURGERY = factor(RAB_SURGERY, labels = c("No", "Yes")))

#Functional status
ukfull$RLIFE <- recode(ukfull$RLIFE,
                       7 ~ NA,
                       8 ~ NA,
                       9 ~ NA,
                       1 ~ 1,
                       2 ~ 1,
                       3 ~ 2,
                       4 ~ 3,
                       5 ~ 3
                       )
ukfull <- ukfull %>%
  mutate(RLIFE = factor(RLIFE, labels = c("Low", "Intermediate", "High")))

#Ascites
ukfull$RASCITES <- recode(ukfull$RASCITES,
                          8 ~ NA,
                          9 ~ NA,
                          1 ~ 0,
                          2 ~ 1
                          )

ukfull <- ukfull %>%
  mutate(RASCITES = factor(RASCITES, labels = c("No ascites", "Ascites")))

#Encephalopathy
ukfull$RENCEPH <- recode(ukfull$RENCEPH,
                         0 ~ 0,
                         1 ~ 1,
                         2 ~ 1,
                         3 ~ 1,
                         4 ~ 1, 
                         8 ~ NA,
                         9 ~ NA
                         )
ukfull <- ukfull %>% 
  mutate(RENCEPH = factor(RENCEPH, labels = c("Not encephalopathic", "Encephalopathic")))

#Blood group
ukfull <- ukfull %>%
  mutate(RBG = factor(RBG, labels = c("0", "A", "B", "AB")))

#Recipient HCV status
ukfull$RANTI_HCV <- recode(ukfull$RANTI_HCV,
                           8 ~ NA,
                           9 ~ NA,
                           1 ~ 0,
                           7 ~ 0,
                           2 ~ 1
                           )

ukfull <- ukfull %>% 
  mutate(RANTI_HCV = factor(RANTI_HCV, labels = c("Negative", "Positive")))

#Recipient albumin
ukfull$RALBUMIN <- recode(ukfull$RALBUMIN,
                          88 ~ NA,
                          99 ~ NA,
                          lo %thru% 6.999 ~ NA,
                          60.001 %thru% hi ~ NA,
                          TRUE ~ copy
                          )

#Convert albumin unit
ukfull <- ukfull %>% mutate(
  RALBUMIN = RALBUMIN/10
)

#Recipient bilirubin
ukfull$RBILIRUBIN <- recode(ukfull$RBILIRUBIN,
                            8888 ~ NA,
                            9999 ~ NA,
                            TRUE ~ copy
)

#Recalculate RBILI
ukfull <- ukfull %>% mutate(
  RBILIRUBIN = RBILIRUBIN/17.1
)

#Recipient creatinine
ukfull$RCREAT <- recode(ukfull$RCREAT,
                            8888 ~ NA,
                            9999 ~ NA,
                            TRUE ~ copy
)

#Convert umol/l to mg/dl
ukfull <- ukfull %>%
  mutate(RCREAT = RCREAT*0.0113)

```

**Recipient disease etiology **
```{r}
#Cancer and acute
ukfull <- ukfull %>%
  mutate(UKT_PLDGRP = case_when(
    PLD >= 440 & PLD <= 447 ~ 1,
    PLD2 >= 440 & PLD2 <= 447 ~ 1,
    PLD3 >= 440 & PLD3 <= 447 ~ 1,
    PLD == 427 ~ 2,
    PLD == 428 ~ 2,
    PLD >= 430 & PLD <= 435 ~ 2,
    PLD >= 437 & PLD <= 439 ~2,
    PLD == 455 ~ 2,
    PLD2 == 427 ~ 2,
    PLD2 == 428 ~ 2,
    PLD2 >= 430 & PLD2 <= 435 ~ 2,
    PLD2 >= 437 & PLD2 <= 439 ~2,
    PLD2 == 455 ~ 2,
    PLD3 == 427 ~ 2,
    PLD3 == 428 ~ 2,
    PLD3 >= 430 & PLD3 <= 435 ~ 2,
    PLD3 >= 437 & PLD3 <= 439 ~2,
    PLD3 == 455 ~ 2,
    PLD == 424 ~ 3,
    PLD2 == 424 ~ 3,
    PLD3 == 424 ~3,
    PLD == 414 ~ 4,
    PLD2 == 414 ~ 4,
    PLD3 == 414 ~ 4,
    PLD == 413 ~ 5,
    PLD == 436 ~ 5,
    PLD2 == 413 ~ 5,
    PLD2 == 436 ~ 5,
    PLD3 == 413 ~ 5,
    PLD3 == 436 ~ 5,
    PLD == 411 ~ 6,
    PLD2 == 411 ~ 6,
    PLD3 == 411 ~ 6,
    PLD == 419 ~ 7,
    PLD2 == 419 ~ 7,
    PLD3 == 419 ~ 7,
    PLD == 412 ~ 8,
    PLD == 417 ~ 8,
    PLD2 == 412 ~ 8,
    PLD2 == 417 ~ 8,
    PLD3 == 412 ~ 8,
    PLD3 == 417 ~ 8,
    PLD == 415 ~ 9,
    PLD == 422 ~ 9,
    PLD == 426 ~ 9,
    PLD == 450 ~ 9,
    PLD == 452 ~ 9,
    PLD == 454 ~ 9,
    PLD == 456 ~ 9,
    PLD == 457 ~ 9,
    PLD == 458 ~ 9,
    PLD == 461 ~ 9,
    PLD == 462 ~ 9,
    PLD == 464 ~ 9,
    PLD == 465 ~ 9,
    PLD == 466 ~ 9,
    PLD == 467 ~ 9,
    PLD == 468 ~ 9,
    PLD == 469 ~ 9,
    PLD == 470 ~ 9,
    PLD == 483 ~ 9,
    PLD2 == 415 ~ 9,
    PLD2 == 422 ~ 9,
    PLD2 == 426 ~ 9,
    PLD2 == 450 ~ 9,
    PLD2 == 452 ~ 9,
    PLD2 == 454 ~ 9,
    PLD2 == 456 ~ 9,
    PLD2 == 457 ~ 9,
    PLD2 == 458 ~ 9,
    PLD2 == 461 ~ 9,
    PLD2 == 462 ~ 9,
    PLD2 == 464 ~ 9,
    PLD2 == 465 ~ 9,
    PLD2 == 466 ~ 9,
    PLD2 == 467 ~ 9,
    PLD2 == 468 ~ 9,
    PLD2 == 469 ~ 9,
    PLD2 == 470 ~ 9,
    PLD2 == 483 ~ 9,
    PLD3 == 415 ~ 9,
    PLD3 == 422 ~ 9,
    PLD3 == 426 ~ 9,
    PLD3 == 450 ~ 9,
    PLD3 == 452 ~ 9,
    PLD3 == 454 ~ 9,
    PLD3 == 456 ~ 9,
    PLD3 == 457 ~ 9,
    PLD3 == 458 ~ 9,
    PLD3 == 461 ~ 9,
    PLD3 == 462 ~ 9,
    PLD3 == 464 ~ 9,
    PLD3 == 465 ~ 9,
    PLD3 == 466 ~ 9,
    PLD3 == 467 ~ 9,
    PLD3 == 468 ~ 9,
    PLD3 == 469 ~ 9,
    PLD3 == 470 ~ 9,
    PLD3 == 483 ~ 9,
    PLD == 410 ~ 10,
    PLD == 416 ~ 10,
    PLD == 418 ~ 10,
    PLD == 420 ~ 10,
    PLD == 421 ~ 10,
    PLD == 423 ~ 10,
    PLD == 425 ~ 10,
    PLD == 448 ~ 10,
    PLD == 451 ~ 10,
    PLD == 453 ~ 10,
    PLD == 459 ~ 10,
    PLD == 460 ~ 10,
    PLD == 463 ~ 10,
    PLD == 471 ~ 10,
    PLD == 472 ~ 10,
    PLD == 473 ~ 10,
    PLD == 474 ~ 10,
    PLD == 475 ~ 10,
    PLD == 476 ~ 10,
    PLD == 477 ~ 10,
    PLD == 478 ~ 10,
    PLD == 479 ~ 10,
    PLD == 480 ~ 10,
    PLD == 481 ~ 10,
    PLD == 482 ~ 10,
    PLD == 484 ~ 10,
    PLD == 485 ~ 10,
    PLD == 486 ~ 10,
    PLD == 498 ~ 10,
    PLD == 499 ~ 10,
    PLD2 == 410 ~ 10,
    PLD2 == 416 ~ 10,
    PLD2 == 418 ~ 10,
    PLD2 == 420 ~ 10,
    PLD2 == 421 ~ 10,
    PLD2 == 423 ~ 10,
    PLD2 == 425 ~ 10,
    PLD2 == 448 ~ 10,
    PLD2 == 451 ~ 10,
    PLD2 == 453 ~ 10,
    PLD2 == 459 ~ 10,
    PLD2 == 460 ~ 10,
    PLD2 == 463 ~ 10,
    PLD2 == 471 ~ 10,
    PLD2 == 472 ~ 10,
    PLD2 == 473 ~ 10,
    PLD2 == 474 ~ 10,
    PLD2 == 475 ~ 10,
    PLD2 == 476 ~ 10,
    PLD2 == 477 ~ 10,
    PLD2 == 478 ~ 10,
    PLD2 == 479 ~ 10,
    PLD2 == 480 ~ 10,
    PLD2 == 481 ~ 10,
    PLD2 == 482 ~ 10,
    PLD2 == 484 ~ 10,
    PLD2 == 485 ~ 10,
    PLD2 == 486 ~ 10,
    PLD2 == 498 ~ 10,
    PLD2 == 499 ~ 10,
    PLD3 == 410 ~ 10,
    PLD3 == 416 ~ 10,
    PLD3 == 418 ~ 10,
    PLD3 == 420 ~ 10,
    PLD3 == 421 ~ 10,
    PLD3 == 423 ~ 10,
    PLD3 == 425 ~ 10,
    PLD3 == 448 ~ 10,
    PLD3 == 451 ~ 10,
    PLD3 == 453 ~ 10,
    PLD3 == 459 ~ 10,
    PLD3 == 460 ~ 10,
    PLD3 == 463 ~ 10,
    PLD3 == 471 ~ 10,
    PLD3 == 472 ~ 10,
    PLD3 == 473 ~ 10,
    PLD3 == 474 ~ 10,
    PLD3 == 475 ~ 10,
    PLD3 == 476 ~ 10,
    PLD3 == 477 ~ 10,
    PLD3 == 478 ~ 10,
    PLD3 == 479 ~ 10,
    PLD3 == 480 ~ 10,
    PLD3 == 481 ~ 10,
    PLD3 == 482 ~ 10,
    PLD3 == 484 ~ 10,
    PLD3 == 485 ~ 10,
    PLD3 == 486 ~ 10,
    PLD3 == 498 ~ 10,
    PLD3 == 499 ~ 10,
))

ukfull <- ukfull %>% 
  mutate(UKT_PLDGRP = factor(UKT_PLDGRP, labels = c("Cancer", "Acute", "HCV", "PSC", "HBV", "PBC", "ALD", "AID", "Metabolic", "Others")))

ukfull <- ukfull %>% mutate(
  ALF = case_when(
    PLD == 427 ~ 1,
    PLD == 428 ~ 1,
    PLD >= 430 & PLD <= 435 ~ 1,
    PLD >= 437 & PLD <= 439 ~1,
    PLD == 455 ~ 1,
    PLD2 == 427 ~ 1,
    PLD2 == 428 ~ 1,
    PLD2 >= 430 & PLD2 <= 435 ~ 1,
    PLD2 >= 437 & PLD2 <= 439 ~1,
    PLD2 == 455 ~ 1,
    PLD3 == 427 ~ 1,
    PLD3 == 428 ~ 1,
    PLD3 >= 430 & PLD3 <= 435 ~ 1,
    PLD3 >= 437 & PLD3 <= 439 ~1,
    PLD3 == 455 ~ 1,
    TRUE ~ 0
  )
)

ukfull <- ukfull %>% mutate(
  HCV = case_when(
    PLD == 424 ~ 1,
    PLD2 == 424 ~ 1,
    PLD3 == 424 ~1,
    TRUE ~ 0
  )
)

ukfull <- ukfull %>% mutate(
  PSC = case_when(
    PLD == 414 ~ 1,
    PLD2 == 414 ~ 1,
    PLD3 == 414 ~ 1,
    TRUE ~ 0
  )
)

ukfull <- ukfull %>% mutate(
  HBV = case_when(
    PLD == 413 ~ 1,
    PLD == 436 ~ 1,
    PLD2 == 413 ~ 1,
    PLD2 == 436 ~ 1,
    PLD3 == 413 ~ 1,
    PLD3 == 436 ~ 1,
    TRUE ~ 0
  )
)

ukfull <- ukfull %>% mutate(
  PBC = case_when(
    PLD == 411 ~ 1,
    PLD2 == 411 ~ 1,
    PLD3 == 411 ~ 1,
    TRUE ~ 0
  )
)

ukfull <- ukfull %>% mutate(
  ALD = case_when(
    PLD == 419 ~ 1,
    PLD2 == 419 ~ 1,
    PLD3 == 419 ~ 1,
    TRUE ~ 0
  )
)

ukfull <- ukfull %>% mutate(
  AID = case_when(
    PLD == 412 ~ 1,
    PLD == 417 ~ 1,
    PLD2 == 412 ~ 1,
    PLD2 == 417 ~ 1,
    PLD3 == 412 ~ 1,
    PLD3 == 417 ~ 1,
    TRUE ~ 0
  )
)

ukfull <- ukfull %>% mutate(
  MET = case_when(
    PLD == 415 ~ 1,
    PLD == 422 ~ 1,
    PLD == 426 ~ 1,
    PLD == 450 ~ 1,
    PLD == 452 ~ 1,
    PLD == 454 ~ 1,
    PLD == 456 ~ 1,
    PLD == 457 ~ 1,
    PLD == 458 ~ 1,
    PLD == 461 ~ 1,
    PLD == 462 ~ 1,
    PLD == 464 ~ 1,
    PLD == 465 ~ 1,
    PLD == 466 ~ 1,
    PLD == 467 ~ 1,
    PLD == 468 ~ 1,
    PLD == 469 ~ 1,
    PLD == 470 ~ 1,
    PLD == 483 ~ 1,
    PLD2 == 415 ~ 1,
    PLD2 == 422 ~ 1,
    PLD2 == 426 ~ 1,
    PLD2 == 450 ~ 1,
    PLD2 == 452 ~ 1,
    PLD2 == 454 ~ 1,
    PLD2 == 456 ~ 1,
    PLD2 == 457 ~ 1,
    PLD2 == 458 ~ 1,
    PLD2 == 461 ~ 1,
    PLD2 == 462 ~ 1,
    PLD2 == 464 ~ 1,
    PLD2 == 465 ~ 1,
    PLD2 == 466 ~ 1,
    PLD2 == 467 ~ 1,
    PLD2 == 468 ~ 1,
    PLD2 == 469 ~ 1,
    PLD2 == 470 ~ 1,
    PLD2 == 483 ~ 1,
    PLD3 == 415 ~ 1,
    PLD3 == 422 ~ 1,
    PLD3 == 426 ~ 1,
    PLD3 == 450 ~ 1,
    PLD3 == 452 ~ 1,
    PLD3 == 454 ~ 1,
    PLD3 == 456 ~ 1,
    PLD3 == 457 ~ 1,
    PLD3 == 458 ~ 1,
    PLD3 == 461 ~ 1,
    PLD3 == 462 ~ 1,
    PLD3 == 464 ~ 1,
    PLD3 == 465 ~ 1,
    PLD3 == 466 ~ 1,
    PLD3 == 467 ~ 1,
    PLD3 == 468 ~ 1,
    PLD3 == 469 ~ 1,
    PLD3 == 470 ~ 1,
    PLD3 == 483 ~ 1,
    TRUE ~ 0
  )
)

ukfull <- ukfull %>% mutate(
  OTH = case_when(
    PLD == 410 ~ 1,
    PLD == 416 ~ 1,
    PLD == 418 ~ 1,
    PLD == 420 ~ 1,
    PLD == 421 ~ 1,
    PLD == 423 ~ 1,
    PLD == 425 ~ 1,
    PLD == 448 ~ 1,
    PLD == 451 ~ 1,
    PLD == 453 ~ 1,
    PLD == 459 ~ 1,
    PLD == 460 ~ 1,
    PLD == 463 ~ 1,
    PLD == 471 ~ 1,
    PLD == 472 ~ 1,
    PLD == 473 ~ 1,
    PLD == 474 ~ 1,
    PLD == 475 ~ 1,
    PLD == 476 ~ 1,
    PLD == 477 ~ 1,
    PLD == 478 ~ 1,
    PLD == 479 ~ 1,
    PLD == 480 ~ 1,
    PLD == 481 ~ 1,
    PLD == 482 ~ 1,
    PLD == 484 ~ 1,
    PLD == 485 ~ 1,
    PLD == 486 ~ 1,
    PLD == 498 ~ 1,
    PLD == 499 ~ 1,
    PLD2 == 410 ~ 1,
    PLD2 == 416 ~ 1,
    PLD2 == 418 ~ 1,
    PLD2 == 420 ~ 1,
    PLD2 == 421 ~ 1,
    PLD2 == 423 ~ 1,
    PLD2 == 425 ~ 1,
    PLD2 == 448 ~ 1,
    PLD2 == 451 ~ 1,
    PLD2 == 453 ~ 1,
    PLD2 == 459 ~ 1,
    PLD2 == 460 ~ 1,
    PLD2 == 463 ~ 1,
    PLD2 == 471 ~ 1,
    PLD2 == 472 ~ 1,
    PLD2 == 473 ~ 1,
    PLD2 == 474 ~ 1,
    PLD2 == 475 ~ 1,
    PLD2 == 476 ~ 1,
    PLD2 == 477 ~ 1,
    PLD2 == 478 ~ 1,
    PLD2 == 479 ~ 1,
    PLD2 == 480 ~ 1,
    PLD2 == 481 ~ 1,
    PLD2 == 482 ~ 1,
    PLD2 == 484 ~ 1,
    PLD2 == 485 ~ 1,
    PLD2 == 486 ~ 1,
    PLD2 == 498 ~ 1,
    PLD2 == 499 ~ 1,
    PLD3 == 410 ~ 1,
    PLD3 == 416 ~ 1,
    PLD3 == 418 ~ 1,
    PLD3 == 420 ~ 1,
    PLD3 == 421 ~ 1,
    PLD3 == 423 ~ 1,
    PLD3 == 425 ~ 1,
    PLD3 == 448 ~ 1,
    PLD3 == 451 ~ 1,
    PLD3 == 453 ~ 1,
    PLD3 == 459 ~ 1,
    PLD3 == 460 ~ 1,
    PLD3 == 463 ~ 1,
    PLD3 == 471 ~ 1,
    PLD3 == 472 ~ 1,
    PLD3 == 473 ~ 1,
    PLD3 == 474 ~ 1,
    PLD3 == 475 ~ 1,
    PLD3 == 476 ~ 1,
    PLD3 == 477 ~ 1,
    PLD3 == 478 ~ 1,
    PLD3 == 479 ~ 1,
    PLD3 == 480 ~ 1,
    PLD3 == 481 ~ 1,
    PLD3 == 482 ~ 1,
    PLD3 == 484 ~ 1,
    PLD3 == 485 ~ 1,
    PLD3 == 486 ~ 1,
    PLD3 == 498 ~ 1,
    PLD3 == 499 ~ 1,
    TRUE ~ 0
  )
)

#Make a NASH yesno
ukfull <- ukfull %>% mutate(
  NASH = case_when(
    PLD == 426 ~ 1,
    PLD2 == 426 ~ 1,
    PLD3 == 426 ~ 1,
    primary_liver_disease_wl == 426 ~ 1,
    secondary_liver_disease_wl == 426 ~ 1,
    tertiary_liver_disease_wl == 426 ~ 1,
    TRUE ~ 0
  )
)

#Make a HCC yesno 
ukfull <- ukfull %>% mutate(
  HCC = case_when(
     PLD >= 440 & PLD <= 447 ~ 1,
    PLD2 >= 440 & PLD2 <= 447 ~ 1,
    PLD3 >= 440 & PLD3 <= 447 ~ 1,
    primary_liver_disease_wl >= 440 & primary_liver_disease_wl <= 447 ~ 1,
    secondary_liver_disease_wl >= 440 & secondary_liver_disease_wl <= 447 ~ 1,
    tertiary_liver_disease_wl >= 440 & tertiary_liver_disease_wl <= 447 ~ 1,
    TRUE ~ 0
  )
)

#Combined HCC
ukfull <- ukfull %>% mutate(
  HCC_combined = case_when(
    ukfull$HCC == 1 & ukfull$UKT_PLDGRP == "HCV" ~ 1,
    ukfull$HCC == 1 & ukfull$UKT_PLDGRP == "PSC" ~ 2,
    ukfull$HCC == 1 & ukfull$UKT_PLDGRP == "HBV" ~ 3,
    ukfull$HCC == 1 & ukfull$UKT_PLDGRP == "PBC" ~ 4,
    ukfull$HCC == 1 & ukfull$UKT_PLDGRP == "ALD" ~ 5,
    ukfull$HCC == 1 & ukfull$UKT_PLDGRP == "AID" ~ 6,
    ukfull$HCC == 1 & ukfull$UKT_PLDGRP == "Metabolic" ~ 7,
    ukfull$HCC == 1 & ukfull$UKT_PLDGRP == "Others" ~ 8,
    TRUE ~ 8
  )
) %>% mutate(
  HCC_combined = factor(HCC_combined, labels = c("HCV-associated", "PSC-associated", "HBV-associated", "PBC-associated", "ALD-associated", "AID-associated", "MET-associated", "Other"))
)

#Combined HCC
ukfull <- ukfull %>% mutate(
  HCC_combined = case_when(
    ukfull$HCC == 1 & ukfull$PLD == 424 ~ 1,
    ukfull$HCC == 1 & ukfull$PLD2 == 424  ~ 1,
    ukfull$HCC == 1 & ukfull$PLD3 == 424 ~ 1,
    ukfull$HCC == 1 & ukfull$PLD ==  414 ~ 2,
    ukfull$HCC == 1 & ukfull$PLD2 ==  414 ~ 2,
    ukfull$HCC == 1 & ukfull$PLD3 == 414 ~ 2,
    ukfull$HCC == 1 & ukfull$PLD == 413 ~ 3,
    ukfull$HCC == 1 & ukfull$PLD == 436 ~ 3,
    ukfull$HCC == 1 & ukfull$PLD2 == 413 ~ 3,
    ukfull$HCC == 1 & ukfull$PLD2 == 436 ~ 3,
    ukfull$HCC == 1 & ukfull$PLD3 == 413 ~ 3,
    ukfull$HCC == 1 & ukfull$PLD3 == 436 ~ 3,
    ukfull$HCC == 1 & ukfull$PLD == 411 ~ 4,
    ukfull$HCC == 1 & ukfull$PLD2 == 411 ~ 4,
    ukfull$HCC == 1 & ukfull$PLD2 == 411 ~ 4,
    ukfull$HCC == 1 & ukfull$PLD == 419 ~ 5,
    ukfull$HCC == 1 & ukfull$PLD2 == 419 ~ 5,
    ukfull$HCC == 1 & ukfull$PLD3 == 419 ~ 5,
    ukfull$HCC == 1 & ukfull$PLD == 412 ~ 6,
    ukfull$HCC == 1 & ukfull$PLD == 417 ~ 6,
    ukfull$HCC == 1 & ukfull$PLD2 == 412 ~ 6,
    ukfull$HCC == 1 & ukfull$PLD2 == 417 ~ 6,
    ukfull$HCC == 1 & ukfull$PLD3 == 412 ~ 6,
    ukfull$HCC == 1 & ukfull$PLD3 == 417 ~ 6,
    ukfull$HCC == 1 & ukfull$PLD == 415 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD == 422 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD == 426 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD == 450 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD == 452 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD == 454 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD == 456 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD == 457 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD == 458 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD == 461 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD == 462 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD == 464 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD == 465 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD == 466 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD == 467 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD == 468 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD == 469 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD == 470 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD == 483 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD2 == 415 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD2 == 422 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD2 == 426 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD2 == 450 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD2 == 452 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD2 == 454 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD2 == 456 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD2 == 457 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD2 == 458 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD2 == 461 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD2 == 462 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD2 == 464 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD2 == 465 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD2 == 466 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD2 == 467 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD2 == 468 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD2 == 469 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD2 == 470 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD2 == 483 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD3 == 415 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD3 == 422 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD3 == 426 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD3 == 450 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD3 == 452 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD3 == 454 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD3 == 456 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD3 == 457 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD3 == 458 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD3 == 461 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD3 == 462 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD3 == 464 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD3 == 465 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD3 == 466 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD3 == 467 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD3 == 468 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD3 == 469 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD3 == 470 ~ 7,
    ukfull$HCC == 1 & ukfull$PLD3 == 483 ~ 7,
    TRUE ~ 8
  )
) %>% mutate(
  HCC_combined = factor(HCC_combined, labels = c("HCV-associated", "PSC-associated", "HBV-associated", "PBC-associated", "ALD-associated", "AID-associated", "MET-associated", "Other"))
)
```

**Causes of death**
```{r}

ukfull <- ukfull %>% mutate(
  COD_cardiovascular = case_when(
    RCOD == 511 ~ 1,
    RCOD2 == 511 ~ 1,
    RCOD == 512 ~ 1,
    RCOD2 == 512 ~ 1,
    RCOD == 517 ~ 1,
    RCOD2 == 517 ~ 1,
    RCOD == 514 ~ 1,
    RCOD2 == 514 ~ 1,
    RCOD == 515 ~ 1,
    RCOD2 == 515 ~ 1,
    RCOD == 516 ~ 1,
    RCOD2 == 516 ~ 1,
    RCOD == 518 ~ 1,
    RCOD2 == 518 ~ 1,
    RCOD == 513 ~ 1,
    RCOD2 == 513 ~ 1,
    RCOD == 576 ~ 1,
    RCOD2 == 576 ~ 1,
    RCOD == 519 ~ 1,
    RCOD2 == 519 ~ 1,
    RCOD == 521 ~ 1,
    RCOD2 == 521 ~ 1,
    RCOD == 522 ~ 1,
    RCOD2 == 522 ~ 1,
    RCOD == 524 ~ 1,
    RCOD2 == 524 ~ 1,
    RCOD == 525 ~ 1,
    RCOD2 == 525 ~ 1,
    RCOD == 526 ~ 1,
    RCOD2 == 526 ~ 1,
    RCOD == 527 ~ 1,
    RCOD2 == 527 ~ 1,
    RCOD == 528 ~ 1,
    RCOD2 == 528 ~ 1,
    RCOD == 523 ~ 1,
    RCOD2 == 523 ~ 1,
    RCOD == 529 ~ 1,
    RCOD2 == 529 ~ 1,
    TRUE ~ 0))

ukfull <- ukfull %>% mutate(COD_cardiovascular = factor(COD_cardiovascular, labels = c("Cardiovascular COD", "Noncardiovascular COD")))

ukfull <- ukfull %>% mutate(
  COD_malignancy = case_when(
    RCOD == 548 ~ 1,
    RCOD2 == 548 ~ 1,
    RCOD == 549 ~ 1,
    RCOD2 == 549 ~ 1,
    RCOD == 566 ~ 1,
    RCOD2 == 566 ~ 1,
    RCOD == 567 ~ 1,
    RCOD2 == 567 ~ 1,
    RCOD == 568 ~ 1,
    RCOD2 == 568 ~ 1,
    RCOD == 573 ~ 1,
    RCOD2 == 573 ~ 1,
    RCOD == 574 ~ 1,
    RCOD2 == 574 ~ 1,
    RCOD == 563 ~ 1,
    RCOD2 == 563 ~ 1,
    RCOD == 564 ~ 1,
    RCOD2 == 564 ~ 1,
    TRUE ~ 0))

ukfull <- ukfull %>% mutate(COD_malignancy = factor(COD_malignancy, labels = c("Malignancy-related COD", "Nonmalignancy-related COD")))

ukfull <- ukfull %>% mutate(
  COD_infection = case_when(
    RCOD == 530 ~ 1,
    RCOD2 == 530 ~ 1,
    RCOD == 531 ~ 1,
    RCOD2 == 531 ~ 1,
    RCOD == 532 ~ 1,
    RCOD2 == 532 ~ 1,
    RCOD == 533 ~ 1,
    RCOD2 == 533 ~ 1,
    RCOD == 534 ~ 1,
    RCOD2 == 534 ~ 1,
    RCOD == 535 ~ 1,
    RCOD2 == 535 ~ 1,
    RCOD == 536 ~ 1,
    RCOD2 == 536 ~ 1,
    RCOD == 537 ~ 1,
    RCOD2 == 537 ~ 1,
    RCOD == 538 ~ 1,
    RCOD2 == 538 ~ 1,
    RCOD == 539 ~ 1,
    RCOD2 == 539 ~ 1,
    TRUE ~ 0))

ukfull <- ukfull %>% mutate(COD_infection = factor(COD_infection, labels = c("Infection COD", "Noninfection COD")))

ukfull <- ukfull %>% mutate(
  COD_liverrelated = case_when(
    RCOD == 541 ~ 1,
    RCOD2 == 541 ~ 1,
    RCOD == 542 ~ 1,
    RCOD2 == 542 ~ 1,
    RCOD == 543 ~ 1,
    RCOD2 == 543 ~ 1,
    RCOD == 544 ~ 1,
    RCOD2 == 544 ~ 1,
    RCOD == 545 ~ 1,
    RCOD2 == 545 ~ 1,
    RCOD == 546 ~ 1,
    RCOD2 == 546 ~ 1,
    RCOD == 590 ~ 1,
    RCOD2 == 590 ~ 1,
    RCOD == 561 ~ 1,
    RCOD2 == 561 ~ 1,
    RCOD == 575 ~ 1,
    RCOD2 == 575 ~ 1,
    TRUE ~ 0))

ukfull <- ukfull %>% mutate(COD_liverrelated = factor(COD_liverrelated, labels = c("Liver disease or graft failure COD", "Nonliverdisease or graft failure COD")))

ukfull <- ukfull %>% mutate(
  COD_other = case_when(
    RCOD == 562 ~ 1,
    RCOD2 == 562 ~ 1,
    RCOD == 571 ~ 1,
    RCOD2 == 571 ~ 1,
    RCOD == 572 ~ 1,
    RCOD2 == 572 ~ 1,
    RCOD == 570 ~ 1,
    RCOD2 == 570 ~ 1,
    RCOD == 547 ~ 1,
    RCOD2 == 547 ~ 1,
    RCOD == 554 ~ 1,
    RCOD2 == 554 ~ 1,
    RCOD == 520 ~ 1,
    RCOD2 == 520 ~ 1,
    RCOD == 577 ~ 1,
    RCOD2 == 577 ~ 1,
    RCOD == 578 ~ 1,
    RCOD2 == 578 ~ 1,
    RCOD == 569 ~ 1,
    RCOD2 == 569 ~ 1,
    RCOD == 579 ~ 1,
    RCOD2 == 579 ~ 1,
    RCOD == 500 ~ 1,
    RCOD2 == 500 ~ 1,
    RCOD == 595 ~ 1,
    RCOD2 == 595 ~ 1,
    RCOD == 598 ~ 1,
    RCOD2 == 598 ~ 1,
    RCOD == 599 ~ 1,
    RCOD2 == 599 ~ 1,
    RCOD == 588 ~ 1,
    RCOD2 == 588 ~ 1,
    RCOD == 581 ~ 1,
    RCOD2 == 581 ~ 1,
    RCOD == 582 ~ 1,
    RCOD2 == 582 ~ 1,
    RCOD == 551 ~ 1,
    RCOD2 == 551 ~ 1,
    RCOD == 552 ~ 1,
    RCOD2 == 552 ~ 1,
    RCOD == 553 ~ 1,
    RCOD2 == 553 ~ 1,
    TRUE ~ 0))

ukfull <- ukfull %>% mutate(COD_other = factor(COD_other, labels = c("Other COD", "Non-Other (previously categorized) COD")))
```

```{r}

#Create a country variable 
ukfull <- ukfull %>% mutate(
  COUNTRY = case_when(
    PCENS >= 0 ~ "UK"
  )
)

ukfull <- ukfull %>% mutate(TRANSPLANT_UNIT = factor(transplant_unit))

ukformerge <- ukfull %>% select(REGID, TX_YR, RAGE, GSURV, GCENS, PSURV, PCENS, LC, DAGE, DTYPE, DONCOD, DBMI, DSEX, DCMV, BLD_GP_MATCH, GRAFT_TYPE, CIT, RSEX, RETHNIC, BMI, WAITLIST_TIME, TRANSPLANT_UNIT, MELD, RREN_SUP, RVENT, RAB_SURGERY, RLIFE, RASCITES, RENCEPH, RBG, RANTI_HCV, RALBUMIN, RINR, RBILIRUBIN, RCREAT, COUNTRY, HCC_combined, UKT_PLDGRP, NASH, COD_cardiovascular, COD_malignancy, COD_infection, COD_liverrelated, COD_other, HCC, HCV, PSC, HBV, PBC, ALD, AID, MET, OTH)
```

**Canadian data**
**Read in data**
```{r}
corrdata <- read_sav("/Users/Ivanics/Desktop/corr_new.sav")
```

**Recoding and renaming**
```{r}
corrdata <- corrdata %>% mutate(TRANSPLANT_UNIT = factor(UHN))

corrdata <- corrdata %>% 
  rename(REGID=RECIPIENT_ID)

#Keep analysis from 2008 onwards
corrdata <- corrdata %>% filter(
  Year >= 2008
)

#Rename TX_YEAR variable
corrdata <- corrdata %>%
  rename(TX_YR = Year)

#Keep only adult patients
corrdata <- corrdata %>% filter(
  Age >= 18
)

corrdata <- corrdata %>% 
  rename(RAGE = Age)

#Limit to first-time liver only transplants (multivisc already excluded)
corrdata <- corrdata %>% filter(
  Graft_num1 == 1
)



corrdata <- corrdata %>% filter(
  gtime_days >= 0
)

corrdata <- corrdata %>% filter(
 time_lastfu_days >= 0
)

corrdata <- corrdata %>% 
  rename(GSURV = gtime_days,
         GCENS = Gstatus_txp,
         PSURV = time_lastfu_days,
         PCENS = Status
         )
```
**Donor characteristics**
```{r}
#Donor age
corrdata <- corrdata %>% rename(
  DAGE = age_years_donor
)

corrdata$DAGE <- as.numeric(corrdata$DAGE)

#Donor type
corrdata$DCD <- 
  recode(corrdata$donor_death_type_code_donor,
                               c(1~1,
                                 0~0,
                                 TRUE~NA
                                 ))


corrdata$LDLT <- 
  recode(corrdata$Allograft_type,
                               c(1~0,
                                 2~1,
                                 3~0
                                 ))

corrdata <- corrdata %>% mutate(
  DTYPE = case_when(
    DCD == 1 ~ 1,
    LDLT == 1 ~ 2,
    TRUE ~ 0
  )
)

corrdata <- corrdata %>% mutate(
  DTYPE = factor(DTYPE, labels = c("DBD", "DCD", "LDLT")) 
)

#Cause of death
corrdata <- corrdata %>% mutate(
  DONCOD = case_when(
    corrdata$DEATH_CAUSE_CADAVER_CODE_donor == "03" ~ 1,
    corrdata$DEATH_CAUSE_CADAVER_CODE_donor == "04" ~ 1,
    corrdata$DEATH_CAUSE_CADAVER_CODE_donor == "02" ~ 2,
    corrdata$DEATH_CAUSE_CADAVER_CODE_donor == "07" ~ 2,
    corrdata$DEATH_CAUSE_CADAVER_CODE_donor == "08" ~ 2,
    corrdata$DEATH_CAUSE_CADAVER_CODE_donor == "10" ~ 2,
    corrdata$DEATH_CAUSE_CADAVER_CODE_donor == "01" ~ 3,
    TRUE ~ 4
  )
)

corrdata <- corrdata %>% mutate(
  DONCOD = factor(DONCOD, labels = c("Trauma", "CVA", "Cerebral Anoxia", "Other")) 
)

#BMI
corrdata <- corrdata %>% rename(DBMI = Donor_BMI)

corrdata$DBMI <- as.numeric(corrdata$DBMI)

#Donor sex
corrdata$DSEX <- 
  recode(corrdata$SEX_CODE,
                               c(1~1,
                                 0~0
                                 ))


corrdata <- corrdata %>% mutate(
  DSEX = factor(DSEX, labels = c("Female", "Male"))
)


#Donor ABO match not appropriately coded

#Donor graft type
corrdata <- corrdata %>% mutate(
  GRAFT_TYPE = case_when(
    ORGAN_TYPE_CODE == 20 ~ 1,
    ORGAN_TYPE_CODE == 21 ~ 2,
    ORGAN_TYPE_CODE == 22 ~ 2,
    ORGAN_TYPE_CODE == 23 ~ 2,
    ORGAN_TYPE_CODE == 29 ~ 2
  )
)

corrdata <- corrdata %>% mutate(
  GRAFT_TYPE = factor(GRAFT_TYPE, labels= c("Whole", "Segmental"))
)


#CIT
corrdata$COLD_ISC_TIME_MINUTES <- as.numeric(corrdata$COLD_ISC_TIME_MINUTES)

corrdata <- corrdata %>% mutate(
  CIT = COLD_ISC_TIME_MINUTES
)

#CMV status donor
corrdata <- corrdata %>% mutate(
  DCMV = case_when(
    corrdata$CMV_FLAG_donor_clean == "1" ~ 1,
    corrdata$CMV_FLAG_donor_clean == "0" ~ 0,
    TRUE ~ NA_real_)) 

corrdata <- corrdata %>% mutate(DCMV = 
    factor(DCMV, labels = c("Negative", "Positive")))
```

**Recipient characteristics**
```{r}
#Gender
corrdata <- corrdata %>% mutate(
  RSEX = case_when(
    SEX_CODE == 1 ~ 1,
    SEX_CODE == 0 ~ 0
  ) 
)

corrdata <- corrdata %>% mutate(
  RSEX = factor(RSEX, labels = c("Female", "Male"))
)

#Ethnicity
corrdata <- corrdata %>% mutate(
  RETHNIC = case_when(
    Racial_Origin == "01" ~ 0,
    Racial_Origin == "03" ~ 1,
    TRUE ~ 2,
  )
)

corrdata <- corrdata %>% mutate(
  RETHNIC = factor(RETHNIC, labels = c("White", "Black", "Other"))
)
  

#Recipient BMI
corrdata <- corrdata %>% rename(
  BMI = RECIPIENT_BMI
)
corrdata$BMI <- as.numeric(corrdata$BMI)

#Waiting list
corrdata$Waitlist_days <- as.numeric(corrdata$Waitlist_days)

corrdata <- corrdata %>% rename(
  WAITLIST_TIME = Waitlist_days
)

#Recipient MELD score
corrdata <- corrdata %>% rename(
  MELD = MELD_Score
)

corrdata$MELD <- as.numeric(corrdata$MELD)

#Renal support
corrdata$RREN_SUP <- 
  recode(corrdata$Prior_Dialysis,
                               c(1~1,
                                 TRUE~0
                               ))

corrdata <- corrdata %>% mutate(
  RREN_SUP = factor(RREN_SUP, labels = c("No pre-tx support", "Pre-tx support"))
)

#Ventilator status
corrdata <- corrdata %>% mutate(
  RVENT = case_when(
    corrdata$MEDICAL_STATUS_CODE_clean == "18" ~ 1,
    corrdata$MEDICAL_STATUS_CODE_clean == "05" ~ 0,
    corrdata$MEDICAL_STATUS_CODE_clean == "11" ~ 0,
    corrdata$MEDICAL_STATUS_CODE_clean == "12" ~ 0,
    corrdata$MEDICAL_STATUS_CODE_clean == "16" ~ 0,
    corrdata$MEDICAL_STATUS_CODE_clean == "17" ~ 0,
    corrdata$MEDICAL_STATUS_CODE_clean == "19" ~ 0,
    TRUE ~ NA_real_
  )  
) %>%
  mutate(
    RVENT = factor(
      RVENT, labels = 
        c("Not ventilated", "Ventilated"
          )))

#Recipient blood group
corrdata <- corrdata %>% mutate(
  RBG = case_when(
    corrdata$BLOOD_TYPE_CODE == "O" ~ 1,
    corrdata$BLOOD_TYPE_CODE == "A" ~ 2,
    corrdata$BLOOD_TYPE_CODE == "B" ~ 3,
    corrdata$BLOOD_TYPE_CODE == "AB" ~ 4
  ))%>% 
  mutate(RBG = factor(RBG, labels = c("0", "A", "B", "AB")))
  
#Recipient HCV status
corrdata$RANTI_HCV <- recode(corrdata$HEPATITIS_C_FLAG_clean,
                             "0" ~ 0,
                             "1" ~ 1,
                             TRUE ~ NA)

corrdata <- corrdata %>%
  mutate(RANTI_HCV = factor(RANTI_HCV, labels = c("Negative", "Positive")))

#INR
corrdata <- corrdata %>% mutate(
  RINR = INR_TX
)

corrdata$RINR <- as.numeric(corrdata$RINR)

#Bilirubin
corrdata <- corrdata %>% rename(
  RBILIRUBIN = SERUM_BILIRUBIN_TX
)

corrdata$RBILIRUBIN <- as.numeric(corrdata$RBILIRUBIN)

#Convert to mg/dl
corrdata <- corrdata %>% mutate(
  RBILIRUBIN = RBILIRUBIN/17.1
)

#Creatinine
corrdata <- corrdata %>% rename(
  RCREAT = CREATININE_TX
)

corrdata$RCREAT <- as.numeric(corrdata$RCREAT)

#Convert umol/l to mg/dl
corrdata <- corrdata %>%
  mutate(RCREAT = RCREAT*0.0113)

#Country code
corrdata <- corrdata %>% mutate(
  COUNTRY = case_when(
    PCENS >= 0 ~ "CAN"
  )
)

#Disease Etiology
corrdata$ORGAN_DIAGNOSIS_CODE_A <- as.numeric(corrdata$ORGAN_DIAGNOSIS_CODE_A)
corrdata$Secondary_diagnosis <- as.numeric(corrdata$Secondary_diagnosis)
corrdata$Tertiary <- as.numeric(corrdata$Tertiary)
corrdata$Quarternary <- as.numeric(corrdata$Quarternary)
str(corrdata$Secondary_diagnosis)

#NASH
corrdata <- corrdata  %>% 
  mutate(NASH = case_when(
    ORGAN_DIAGNOSIS_CODE_A == 64 ~ 1,
    Secondary_diagnosis == 64 ~ 1,
    Tertiary == 64 ~ 1,
    Quarternary == 64 ~ 1,
    TRUE ~ 0
  ))

#HCC
corrdata <- corrdata %>% mutate(
  HCC = case_when(
    ORGAN_DIAGNOSIS_CODE_A == 16 ~ 1,
    Secondary_diagnosis == 16 ~ 1,
    Tertiary == 16 ~ 1,
    Quarternary == 16 ~ 1,
    TRUE ~ 0
  )
)

#ALF
corrdata <- corrdata %>% mutate(
  ALF = case_when(
      corrdata$ORGAN_DIAGNOSIS_CODE_A == 4 ~ 1,
      corrdata$ORGAN_DIAGNOSIS_CODE_A == 5 ~ 1, 
      corrdata$ORGAN_DIAGNOSIS_CODE_A == 35 ~ 1, 
      corrdata$ORGAN_DIAGNOSIS_CODE_A == 47 ~ 1,
      corrdata$ORGAN_DIAGNOSIS_CODE_A == 56 ~ 1, 
      corrdata$ORGAN_DIAGNOSIS_CODE_A == 58 ~ 1, 
      corrdata$ORGAN_DIAGNOSIS_CODE_A == 61 ~ 1,
      corrdata$Secondary_diagnosis == 4 ~ 1, 
      corrdata$Secondary_diagnosis == 5 ~ 1, 
      corrdata$Secondary_diagnosis == 35 ~ 1, 
      corrdata$Secondary_diagnosis == 47 ~ 1, 
      corrdata$Secondary_diagnosis == 56 ~ 1,
      corrdata$Secondary_diagnosis == 58 ~ 1, 
      corrdata$Secondary_diagnosis == 61 ~ 1,
      corrdata$Tertiary == 4 ~ 1, 
      corrdata$Tertiary == 5 ~ 1, 
      corrdata$Tertiary == 35 ~ 1, 
      corrdata$Tertiary == 47 ~ 1, 
      corrdata$Tertiary == 56 ~ 1, 
      corrdata$Tertiary == 58 ~ 1, 
      corrdata$Tertiary == 61 ~ 1,
      corrdata$Quarternary == 4 ~ 1, 
      corrdata$Quarternary == 5 ~ 1, 
      corrdata$Quarternary == 35 ~ 1, 
      corrdata$Quarternary == 47 ~ 1, 
      corrdata$Quarternary == 56 ~ 1, 
      corrdata$Quarternary == 58 ~ 1, 
      corrdata$Quarternary == 61 ~ 1,
    TRUE ~ 0
  )
)

#HCV
corrdata <- corrdata %>% mutate(
  HCV = case_when(
      corrdata$ORGAN_DIAGNOSIS_CODE_A == 60 ~ 1,
      corrdata$Secondary_diagnosis == 60 ~ 1,
      corrdata$Tertiary == 60 ~ 1,
      corrdata$Quarternary == 60 ~ 1,
    TRUE ~ 0
  )
)

#PSC
corrdata <- corrdata %>% mutate(
  PSC =  case_when(
      corrdata$ORGAN_DIAGNOSIS_CODE_A == 11 ~ 1,
      corrdata$Secondary_diagnosis == 11 ~ 1,
      corrdata$Tertiary == 11 ~ 1,
      corrdata$Quarternary == 11 ~ 1,
    TRUE ~ 0
  )
)

#HBV
corrdata <- corrdata %>% mutate(
  HBV = case_when(
      corrdata$ORGAN_DIAGNOSIS_CODE_A == 43 ~ 1,
      corrdata$Secondary_diagnosis == 43 ~ 1,
      corrdata$Tertiary == 43 ~ 1,
      corrdata$Quarternary == 43 ~ 1,
      corrdata$ORGAN_DIAGNOSIS_CODE_A == 2 ~ 1,
      corrdata$Secondary_diagnosis == 2 ~ 1,
      corrdata$Tertiary == 2 ~ 1,
      corrdata$Quarternary == 2 ~ 1,
    TRUE ~ 0
  )
)

#PBC
corrdata <- corrdata %>% mutate(
  PBC = case_when(
      corrdata$ORGAN_DIAGNOSIS_CODE_A == 7 ~ 1,
      corrdata$Secondary_diagnosis == 7 ~ 1,
      corrdata$Tertiary == 7 ~ 1,
      corrdata$Quarternary == 7 ~ 1,
    TRUE ~ 0
  )
)

#Alcoholic
corrdata <- corrdata %>% mutate(
  ALD = case_when(
      corrdata$ORGAN_DIAGNOSIS_CODE_A == 9 ~ 1,
      corrdata$Secondary_diagnosis == 9 ~ 1,
      corrdata$Tertiary == 9 ~ 1,
      corrdata$Quarternary == 9 ~ 1,
    TRUE ~ 0
  )
)

#Autoimmune and cryptogenic
corrdata <- corrdata %>% mutate(
  AID = case_when(
      corrdata$ORGAN_DIAGNOSIS_CODE_A == 8 ~ 1,
      corrdata$Secondary_diagnosis == 8 ~ 1,
      corrdata$Tertiary == 8 ~ 1,
      corrdata$Quarternary == 8 ~ 1,
      corrdata$ORGAN_DIAGNOSIS_CODE_A == 6 ~ 1,
      corrdata$Secondary_diagnosis == 6 ~ 1,
      corrdata$Tertiary == 6 ~ 1,
      corrdata$Quarternary == 6 ~ 1,
    TRUE ~ 0
  )
)

#Metabolic liver disease
corrdata <- corrdata %>% mutate(
  MET = case_when(
      corrdata$ORGAN_DIAGNOSIS_CODE_A == 64 ~ 1,
      corrdata$Secondary_diagnosis == 64 ~ 1,
      corrdata$Tertiary == 64 ~ 1,
      corrdata$Quarternary == 64 ~ 1,
      corrdata$ORGAN_DIAGNOSIS_CODE_A == 20 ~ 1,
      corrdata$Secondary_diagnosis == 20 ~ 1,
      corrdata$Tertiary == 20 ~ 1,
      corrdata$Quarternary == 20 ~ 1,
      corrdata$ORGAN_DIAGNOSIS_CODE_A == 22 ~ 1,
      corrdata$Secondary_diagnosis == 22 ~ 1,
      corrdata$Tertiary == 22 ~ 1,
      corrdata$Quarternary == 22 ~ 1,
      corrdata$ORGAN_DIAGNOSIS_CODE_A == 23 ~ 1,
      corrdata$Secondary_diagnosis == 23 ~ 1,
      corrdata$Tertiary == 23 ~ 1,
      corrdata$Quarternary == 23 ~ 1,
      corrdata$ORGAN_DIAGNOSIS_CODE_A == 34 ~ 1,
      corrdata$Secondary_diagnosis == 34 ~ 1,
      corrdata$Tertiary == 34 ~ 1,
      corrdata$Quarternary == 34 ~ 1,
      corrdata$ORGAN_DIAGNOSIS_CODE_A == 34 ~ 1,
      corrdata$Secondary_diagnosis == 34 ~ 1,
      corrdata$Tertiary == 34 ~ 1,
      corrdata$Quarternary == 34 ~ 1,
    TRUE ~ 0
  )
)

#Other 
corrdata <- corrdata %>% mutate(
  OTH = case_when(
    HCC == 0 & ALF == 0 & HCV == 0 & PSC == 0 & HBV == 0 & PBC == 0 & ALD == 0 & AID == 0 & MET == 0 ~ 1,
    TRUE ~ 0
  )
)


corrdata <- corrdata %>% mutate(
  UKT_PLDGRP = case_when(
    HCC == 1 ~ 1,
    ALF == 1 ~ 2,
    HCV == 1 ~ 3,
    PSC == 1 ~ 4,
    HBV == 1 ~ 5,
    PBC == 1 ~ 6,
    ALD == 1 ~ 7,
    AID == 1 ~ 8,
    MET == 1 ~ 9,
    OTH == 1 ~ 10
  )
) %>%
  mutate(UKT_PLDGRP = factor(UKT_PLDGRP, labels = c("HCC", "ALF", "HCV", "PSC", "HBV", "PBC", "ALD", "AID", "Metabolic", "Others")))

#Combined HCC
corrdata <- corrdata %>% mutate(
  HCC_combined = case_when(
    corrdata$HCC == 1 & corrdata$HCV == 1 ~ 1,
    corrdata$HCC == 1 & corrdata$PSC == 1 ~ 2,
    corrdata$HCC == 1 & corrdata$HBV == 1 ~ 3,
    corrdata$HCC == 1 & corrdata$PBC == 1 ~ 4,
    corrdata$HCC == 1 & corrdata$ALD == 1 ~ 5,
    corrdata$HCC == 1 & corrdata$AID == 1 ~ 6,
    corrdata$HCC == 1 & corrdata$MET == 1 ~ 7,
    corrdata$HCC == 1 & corrdata$OTH == 1 ~ 8,
    TRUE ~ 0
  )
) %>% mutate(
  HCC_combined = factor(HCC_combined, labels = c("HCV-associated", "PSC-associated", "HBV-associated", "PBC-associated", "ALD-associated", "AID-associated", "MET-associated", "Other"))
)
```

**Causes of death**
```{r}
corrdata <- corrdata %>% mutate(DEATH_CAUSE_CODE = as.numeric(DEATH_CAUSE_CODE))

corrdata <- corrdata %>% mutate(
  COD_cardiovascular = case_when(
    DEATH_CAUSE_CODE == 11 ~ 1,
    DEATH_CAUSE_CODE == 11 ~ 1,
    DEATH_CAUSE_CODE == 12 ~ 1,
    DEATH_CAUSE_CODE == 12 ~ 1,
    DEATH_CAUSE_CODE == 17 ~ 1,
    DEATH_CAUSE_CODE == 17 ~ 1,
    DEATH_CAUSE_CODE == 14 ~ 1,
    DEATH_CAUSE_CODE == 14 ~ 1,
    DEATH_CAUSE_CODE == 15 ~ 1,
    DEATH_CAUSE_CODE == 15 ~ 1,
    DEATH_CAUSE_CODE == 16 ~ 1,
    DEATH_CAUSE_CODE == 16 ~ 1,
    DEATH_CAUSE_CODE == 18 ~ 1,
    DEATH_CAUSE_CODE == 18 ~ 1,
    DEATH_CAUSE_CODE == 13 ~ 1,
    DEATH_CAUSE_CODE == 13 ~ 1,
    DEATH_CAUSE_CODE == 21 ~ 1,
    DEATH_CAUSE_CODE == 21 ~ 1,
    DEATH_CAUSE_CODE == 22 ~ 1,
    DEATH_CAUSE_CODE == 22 ~ 1,
    DEATH_CAUSE_CODE == 30 ~ 1,
    DEATH_CAUSE_CODE == 30 ~ 1,
    DEATH_CAUSE_CODE == 24 ~ 1,
    DEATH_CAUSE_CODE == 24 ~ 1,
    DEATH_CAUSE_CODE == 25 ~ 1,
    DEATH_CAUSE_CODE == 25 ~ 1,
    DEATH_CAUSE_CODE == 26 ~ 1,
    DEATH_CAUSE_CODE == 26 ~ 1,
    DEATH_CAUSE_CODE == 27 ~ 1,
    DEATH_CAUSE_CODE == 27 ~ 1,
    DEATH_CAUSE_CODE == 28 ~ 1,
    DEATH_CAUSE_CODE == 28 ~ 1,
    DEATH_CAUSE_CODE == 23 ~ 1,
    DEATH_CAUSE_CODE == 23 ~ 1,
    DEATH_CAUSE_CODE == 29 ~ 1,
    DEATH_CAUSE_CODE == 29 ~ 1,
    DEATH_CAUSE_CODE == 55 ~ 1,
    DEATH_CAUSE_CODE == 55 ~ 1,
    DEATH_CAUSE_CODE == 73 ~ 1,
    DEATH_CAUSE_CODE == 73 ~ 1,
    DEATH_CAUSE_CODE == 56 ~ 1,
    DEATH_CAUSE_CODE == 56 ~ 1,
    DEATH_CAUSE_CODE == 57 ~ 1,
    DEATH_CAUSE_CODE == 57 ~ 1,
    DEATH_CAUSE_CODE == 71 ~ 1,
    DEATH_CAUSE_CODE == 71 ~ 1,
    TRUE ~ 0))

corrdata <- corrdata %>% mutate(COD_cardiovascular = factor(COD_cardiovascular, labels = c("Cardiovascular COD", "Noncardiovascular COD")))

corrdata <- corrdata %>% mutate(
  COD_malignancy = case_when(
    DEATH_CAUSE_CODE == 66 ~ 1,
    DEATH_CAUSE_CODE == 66 ~ 1,
    DEATH_CAUSE_CODE == 67 ~ 1,
    DEATH_CAUSE_CODE == 67 ~ 1,
    DEATH_CAUSE_CODE == 63 ~ 1,
    DEATH_CAUSE_CODE == 63 ~ 1,
    DEATH_CAUSE_CODE == 64 ~ 1,
    DEATH_CAUSE_CODE == 64 ~ 1,
    TRUE ~ 0))

corrdata <- corrdata %>% mutate(COD_malignancy = factor(COD_malignancy, labels = c("Malignancy-related COD", "Nonmalignancy-related COD")))

corrdata <- corrdata %>% mutate(
  COD_infection = case_when(
    DEATH_CAUSE_CODE == 3 ~ 1,
    DEATH_CAUSE_CODE == 3 ~ 1,
    DEATH_CAUSE_CODE == 4 ~ 1,
    DEATH_CAUSE_CODE == 4 ~ 1,
    DEATH_CAUSE_CODE == 5 ~ 1,
    DEATH_CAUSE_CODE == 5 ~ 1,
    DEATH_CAUSE_CODE == 6 ~ 1,
    DEATH_CAUSE_CODE == 6 ~ 1,
    DEATH_CAUSE_CODE == 7 ~ 1,
    DEATH_CAUSE_CODE == 7 ~ 1,
    DEATH_CAUSE_CODE == 8 ~ 1,
    DEATH_CAUSE_CODE == 8 ~ 1,
    DEATH_CAUSE_CODE == 9 ~ 1,
    DEATH_CAUSE_CODE == 9 ~ 1,
    DEATH_CAUSE_CODE == 10 ~ 1,
    DEATH_CAUSE_CODE == 10 ~ 1,
    DEATH_CAUSE_CODE == 31 ~ 1,
    DEATH_CAUSE_CODE == 31 ~ 1,
    DEATH_CAUSE_CODE == 32 ~ 1,
    DEATH_CAUSE_CODE == 32 ~ 1,
    DEATH_CAUSE_CODE == 33 ~ 1,
    DEATH_CAUSE_CODE == 33 ~ 1,
    DEATH_CAUSE_CODE == 36 ~ 1,
    DEATH_CAUSE_CODE == 36 ~ 1,
    DEATH_CAUSE_CODE == 37 ~ 1,
    DEATH_CAUSE_CODE == 37 ~ 1,
    DEATH_CAUSE_CODE == 34 ~ 1,
    DEATH_CAUSE_CODE == 34 ~ 1,
    DEATH_CAUSE_CODE == 35 ~ 1,
    DEATH_CAUSE_CODE == 35 ~ 1,
    DEATH_CAUSE_CODE == 38 ~ 1,
    DEATH_CAUSE_CODE == 38 ~ 1,
    DEATH_CAUSE_CODE == 39 ~ 1,
    DEATH_CAUSE_CODE == 39 ~ 1,
    TRUE ~ 0))

corrdata <- corrdata %>% mutate(COD_infection = factor(COD_infection, labels = c("Infection COD", "Noninfection COD")))

corrdata <- corrdata %>% mutate(
  COD_liverrelated = case_when(
    DEATH_CAUSE_CODE == 41 ~ 1,
    DEATH_CAUSE_CODE == 41 ~ 1,
    DEATH_CAUSE_CODE == 42 ~ 1,
    DEATH_CAUSE_CODE == 42 ~ 1,
    DEATH_CAUSE_CODE == 43 ~ 1,
    DEATH_CAUSE_CODE == 43 ~ 1,
    DEATH_CAUSE_CODE == 44 ~ 1,
    DEATH_CAUSE_CODE == 44 ~ 1,
    DEATH_CAUSE_CODE == 45 ~ 1,
    DEATH_CAUSE_CODE == 45 ~ 1,
    DEATH_CAUSE_CODE == 46 ~ 1,
    DEATH_CAUSE_CODE == 46 ~ 1,
    DEATH_CAUSE_CODE == 74 ~ 1,
    DEATH_CAUSE_CODE == 74 ~ 1,
    DEATH_CAUSE_CODE == 61 ~ 1,
    DEATH_CAUSE_CODE == 61 ~ 1,
    TRUE ~ 0))

corrdata <- corrdata %>% mutate(COD_liverrelated = factor(COD_liverrelated, labels = c("Liver disease or graft failure COD", "Nonliverdisease or graft failure COD")))

corrdata <- corrdata %>% mutate(
  COD_other = case_when(
    DEATH_CAUSE_CODE == 2 ~ 1,
    DEATH_CAUSE_CODE == 2 ~ 1,
    DEATH_CAUSE_CODE == 20 ~ 1,
    DEATH_CAUSE_CODE == 20 ~ 1,
    DEATH_CAUSE_CODE == 62 ~ 1,
    DEATH_CAUSE_CODE == 62 ~ 1,
    DEATH_CAUSE_CODE == 68 ~ 1,
    DEATH_CAUSE_CODE == 68 ~ 1,
    DEATH_CAUSE_CODE == 69 ~ 1,
    DEATH_CAUSE_CODE == 69 ~ 1,
    DEATH_CAUSE_CODE == 70 ~ 1,
    DEATH_CAUSE_CODE == 70 ~ 1,
    DEATH_CAUSE_CODE == 40 ~ 1,
    DEATH_CAUSE_CODE == 40 ~ 1,
    DEATH_CAUSE_CODE == 47 ~ 1,
    DEATH_CAUSE_CODE == 47 ~ 1,
    DEATH_CAUSE_CODE == 48 ~ 1,
    DEATH_CAUSE_CODE == 48 ~ 1,
    DEATH_CAUSE_CODE == 59 ~ 1,
    DEATH_CAUSE_CODE == 59 ~ 1,
    DEATH_CAUSE_CODE == 75 ~ 1,
    DEATH_CAUSE_CODE == 75 ~ 1,
    DEATH_CAUSE_CODE == 19 ~ 1,
    DEATH_CAUSE_CODE == 19 ~ 1,
    DEATH_CAUSE_CODE == 49 ~ 1,
    DEATH_CAUSE_CODE == 49 ~ 1,
    DEATH_CAUSE_CODE == 77 ~ 1,
    DEATH_CAUSE_CODE == 77 ~ 1,
    DEATH_CAUSE_CODE == 90 ~ 1,
    DEATH_CAUSE_CODE == 90 ~ 1,
    DEATH_CAUSE_CODE == 0 ~ 1,
    DEATH_CAUSE_CODE == 0 ~ 1,
    DEATH_CAUSE_CODE == 99 ~ 1,
    DEATH_CAUSE_CODE == 99 ~ 1,
    DEATH_CAUSE_CODE == 81 ~ 1,
    DEATH_CAUSE_CODE == 81 ~ 1,
    DEATH_CAUSE_CODE == 82 ~ 1,
    DEATH_CAUSE_CODE == 82 ~ 1,
    DEATH_CAUSE_CODE == 50 ~ 1,
    DEATH_CAUSE_CODE == 50 ~ 1,
    DEATH_CAUSE_CODE == 51 ~ 1,
    DEATH_CAUSE_CODE == 51 ~ 1,
    DEATH_CAUSE_CODE == 52 ~ 1,
    DEATH_CAUSE_CODE == 52 ~ 1,
    DEATH_CAUSE_CODE == 53 ~ 1,
    DEATH_CAUSE_CODE == 53 ~ 1,
    DEATH_CAUSE_CODE == 54 ~ 1,
    DEATH_CAUSE_CODE == 54 ~ 1,
    TRUE ~ 0
    ))

corrdata <- corrdata %>% mutate(COD_other = factor(COD_other, labels = c("Other COD", "Non-Other (previously categorized) COD")))
```

```{r}
#CORR
corrdataformerge <- corrdata %>% select(REGID, TX_YR, RAGE, GSURV, GCENS, PSURV, PCENS, DAGE, DTYPE, DONCOD, DBMI, DCMV, DSEX, GRAFT_TYPE, CIT, RSEX, RETHNIC, BMI, WAITLIST_TIME, MELD, RREN_SUP, RBG, RANTI_HCV, RINR, RBILIRUBIN, RCREAT, COUNTRY, HCC_combined, UKT_PLDGRP, NASH, COD_cardiovascular, COD_malignancy, COD_infection, COD_liverrelated, COD_other, UHN, HCC, HCV, PSC, HBV, PBC, ALD, AID, MET, OTH, TRANSPLANT_UNIT)
```

```{r}
#UNOS
unosformerge <- unosdata %>% select(REGID, TX_YR, RAGE, GSURV, PSURV, PCENS, GCENS, LC, DAGE, DTYPE, DONCOD, DBMI, DCMV, DSEX, BLD_GP_MATCH, GRAFT_TYPE, CIT, RSEX, RETHNIC, BMI, WAITLIST_TIME, TRANSPLANT_UNIT, MELD, RREN_SUP, RVENT, RAB_SURGERY, RLIFE, RASCITES, RENCEPH, RBG, RANTI_HCV, RALBUMIN, RINR, RBILIRUBIN, RCREAT, COUNTRY, HCC_combined, UKT_PLDGRP, NASH, COD_cardiovascular, COD_malignancy, COD_infection, COD_liverrelated, COD_other, HCC, HCV, PSC, HBV, PBC, ALD, AID, MET, OTH)

```

```{r}
bound3 <- bind_rows(unosformerge, ukformerge, corrdataformerge)
```
**Cleaning up bound file**
```{r}
write_csv(bound3, path = "/Users/Ivanics/Desktop/GitHub/International-LDLT/Datafile/merged.csv")
```


